var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;var Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop){if(name.charAt(0)==="#"){prototype[name.substring(1)]=prototype[prop[name]]}else{prototype[name]=typeof prop[name]==="function"&&typeof _super[name]==="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var res=fn.apply(this,arguments);this._super=tmp;return res}}(name,prop[name]):prop[name]}}function Class(){if(!initializing&&this.init){this.init.apply(this,arguments)}}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;Class._superclass=this;return Class};var each=function(collection,fn,context){if(collection){if(collection.__type=="collection"){return collection.each(fn,context)}var ctu=true;var stop=function(){ctu=false};if(is_array(collection)){var res=[],res_item;for(var c=0,l=collection.length;c<l;c++){res_item;if(ctu==false)break;if(context){res_item=fn.call(context,c,collection[c],stop)}else{res_item=fn(c,collection[c],stop)}res.push(res_item)}return res}else{var name,res={};for(name in collection){if(ctu==false)break;if(context){res[name]=fn.call(context,name,collection[name],stop)}else{res[name]=fn(name,collection[name],stop)}}return res}}};var eac=function(collection,fn,context){if(collection){if(collection.__type=="collection"){return collection.eac(fn,context)}var ctu=true;var stop=function(){ctu=false};if(is_array(collection)){var res=[],res_item;for(var c=0,l=collection.length;c<l;c++){res_item;if(ctu==false)break;if(context){res_item=fn.call(context,collection[c],c,stop)}else{res_item=fn(collection[c],c,stop)}res.push(res_item)}return res}else{var name,res={};for(name in collection){if(ctu==false)break;if(context){res[name]=fn.call(context,collection[name],name,stop)}else{res[name]=fn(collection[name],name,stop)}}return res}}};var jq_class2type={};var jq_type=function(obj){if(obj==null)return String(obj);var s=Object.prototype.toString.call(obj);return jq_class2type[s]||"object"};var is_array=Array.isArray||function(obj){return jq_type(obj)==="array"};var is_dom_node=function isDomNode(obj){return!!obj&&typeof obj.nodeType!="undefined"&&typeof obj.childNodes!="undefined"};jq_class2type["[object Boolean]"]="boolean";jq_class2type["[object Number]"]="number";jq_class2type["[object String]"]="string";jq_class2type["[object Function]"]="function";jq_class2type["[object Array]"]="array";jq_class2type["[object Date]"]="date";jq_class2type["[object RegExp]"]="regexp";jq_class2type["[object Object]"]="object";var jq_isFunction=function(obj){return jq_type(obj)==="function"};var jq_isWindow=function(obj){return obj&&typeof obj==="object"&&"setInterval"in obj};var hasOwn=Object.prototype.hasOwnProperty;var jq_isPlainObject=function(obj){if(!obj||jq_type(obj)!=="object"||obj.nodeType||jq_isWindow(obj)){return false}if(obj.constructor&&!hasOwn.call(obj,"constructor")&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf")){return false}var key;for(key in obj){}return key===undefined||hasOwn.call(obj,key)};var jq_extend=function(){var options,name,src,copy,copyis_array,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&!jq_isFunction(target)){target={}}if(length===i){target=this;--i}for(;i<length;i++){if((options=arguments[i])!=null){if(is_array(options)){for(var name=0,l=options.length;name<l;name++){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(jq_isPlainObject(copy)||(copyis_array=is_array(copy)))){if(copyis_array){copyis_array=false;clone=src&&is_array(src)?src:[]}else{clone=src&&jq_isPlainObject(src)?src:{}}target[name]=jq_extend(deep,clone,copy)}else{target[name]=copy}}}else{for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(jq_isPlainObject(copy)||(copyis_array=is_array(copy)))){if(copyis_array){copyis_array=false;clone=src&&is_array(src)?src:[]}else{clone=src&&jq_isPlainObject(src)?src:{}}target[name]=jq_extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}}return target};var extend=jq_extend;var get_truth_map_from_arr=function(arr){var res={};each(arr,function(i,v){res[v]=true});return res};var get_map_from_arr=function(arr){var res={};for(var c=0,l=arr.length;c<l;c++){res[arr[c]]=c}return res};var arr_like_to_arr=function(arr_like){var res=new Array(arr_like.length);for(var c=0,l=arr_like.length;c<l;c++){res[c]=arr_like[c]}return res};var is_ctrl=function(obj){return typeof obj!="undefined"&&obj!=null&&is_defined(obj._)&&is_defined(obj.__type_name)};var tof=function(obj,t1){var res=t1||typeof obj;if(res=="number"||res=="string"||res=="function"||res=="boolean"){return res}if(res=="object"){if(typeof obj!="undefined"){if(obj===null){return"null"}if(obj.__type){return obj.__type}else{if(obj instanceof Date){return"date"}if(is_array(obj)){return"array"}else if(is_ctrl(obj)){return"control"}else{if(obj instanceof RegExp)res="regex";if(typeof window==="undefined"){if(obj instanceof Buffer)res="buffer";if(obj instanceof Stream.Readable)res="readable_stream";if(obj instanceof Stream.Writable)res="writable_stream"}}return res}}else{return"undefined"}}return res};var atof=function(arr){var res=new Array(arr.length);for(var c=0,l=arr.length;c<l;c++){res[c]=tof(arr[c])}return res};var is_defined=function(value){return typeof value!="undefined"},isdef=is_defined;var is_data_object=function(obj){if(obj){if(obj.__type=="data_object")return true;if(obj.__type=="collection")return true}return false};var is_collection=function(obj){if(obj){if(obj.__type=="collection")return true}return false};var stringify=function(obj,includeFunctions,excludingProps){var _stringify=function(obj,includeFunctions,callerObjItem){var isCircularReference=function(obj,callerObjItem){while(callerObjItem){if(callerObjItem.obj===obj)return true;callerObjItem=callerObjItem.prev}return false};if(isCircularReference(obj,callerObjItem))return"(CircularRef)";var t=typeof obj,res=[];if(obj===String){return"JS_String"}if(t=="object"){if(obj&&is_defined(obj.stringify)){return obj.stringify()}else{var ia=is_array(obj);if(ia){res.push("[");var first=true;for(var c=0;c<obj.length;c++){if(!first)res.push(", ");res.push(_stringify(obj[c],includeFunctions,{prev:callerObjItem,obj:obj}));first=false}res.push("]")}else if(obj==null){res=["null"]}else{if(is_defined(obj.toString)&&obj.toString.stringify===true){res.push('"'+obj.toString()+'"')}else{var propIsPrintable=function(name,value){if(!includeFunctions&&tof(value)==="function")return false;if(excludingProps){for(var i=0;i<excludingProps.length;i++){if(name==excludingProps[i])return false}}return true};var first=true;res.push("{");each(obj,function(i,v){if(propIsPrintable(i,v)){if(!first)res.push(", ");res.push('"'+i+'": '+_stringify(v,includeFunctions,{prev:callerObjItem,obj:obj}));first=false}});res.push("}")}}}}else if(t=="string"){res.push('"'+obj+'"')}else if(t=="undefined"){res=["undefined"]}else if(t=="function"){if(!!includeFunctions){res=[obj.toString()]}}else{res=[obj.toString()]}return res.join("")};return _stringify(obj,includeFunctions)};var get_item_sig=function(i,arr_depth){var res;var t1=typeof i;if(t1=="string"){res="s"}else if(t1=="number"){res="n"}else if(t1=="boolean"){res="b"}else if(t1=="function"){res="f"}else{var t=tof(i,t1);if(t=="array"){if(arr_depth){res="[";for(var c=0,l=i.length;c<l;c++){if(c>0)res=res+",";res=res+get_item_sig(i[c],arr_depth-1)}res=res+"]"}else{res="a"}}else if(t=="control"){res="c"}else if(t=="date"){res="d"}else if(t=="regex"){res="r"}else if(t=="buffer"){res="B"}else if(t=="readable_stream"){res="R"}else if(t=="writable_stream"){res="W"}else if(t=="object"){res="o"}else if(t=="undefined"){res="u"}else{if(t=="collection_index"){return"X"}else if(t=="data_object"){if(i._abstract){res="~D"}else{res="D"}}else{if(t=="data_value"){if(i._abstract){res="~V"}else{res="V"}}else if(t=="null"){res="!"}else if(t=="collection"){if(i._abstract){res="~C"}else{res="C"}}else{throw"Unexpected object type "+t}}}}return res};var trim_sig_brackets=function(sig){if(tof(sig)=="string"){if(sig.charAt(0)=="["&&sig.charAt(sig.length-1)=="]"){return sig.substring(1,sig.length-1)}else{return sig}}};var arr_trim_undefined=function(arr_like){var res=[];var last_defined=-1;var t,v;for(var c=0,l=arr_like.length;c<l;c++){v=arr_like[c];t=tof(v);if(t=="undefined"){}else{last_defined=c}}for(var c=0,l=arr_like.length;c<l;c++){if(c<=last_defined){res.push(arr_like[c])}}return res};var functional_polymorphism=function(options,fn){var a0=arguments;if(a0.length==1){fn=a0[0];options=null}var arr_slice=Array.prototype.slice;var arr,sig,a2,l,a;return function(){a=arguments;l=a.length;if(l==1){sig=get_item_sig([a[0]],1);a2=[a[0]];a2.l=1;return fn.call(this,a2,sig)}else if(l>1){arr=arr_trim_undefined(arr_slice.call(a,0));sig=get_item_sig(arr,1);arr.l=arr.length;return fn.call(this,arr,sig)}else if(a.length==0){arr=new Array(0);arr.l=0;return fn.call(this,arr,"[]")}}};var fp=functional_polymorphism;var arrayify=fp(function(a,sig){var param_index,fn;var res;var process_as_fn=function(){res=function(){var a=arr_like_to_arr(arguments),ts=atof(a),t=this;var last_arg=a[a.length-1];if(tof(last_arg)=="function"){if(typeof param_index!=="undefined"&&ts[param_index]=="array"){var res=[];var fns=[];each(a[param_index],function(i,v){var new_params=a.slice(0,a.length-1);new_params[param_index]=v;fns.push([t,fn,new_params])});call_multiple_callback_functions(fns,function(err,res){if(err){throw err}else{var a=[];a=a.concat.apply(a,res);var callback=last_arg;callback(null,a)}})}else{return fn.apply(t,a)}}else{if(typeof param_index!=="undefined"&&ts[param_index]=="array"){var res=[];each(a[param_index],function(i,v){var new_params=a;new_params[param_index]=v;var result=fn.apply(t,new_params);res.push(result)});return res}else{return fn.apply(t,a)}}}};if(sig=="[o]"){var res=[];each(a[0],function(i,v){res.push([i,v])})}else if(sig=="[f]"){param_index=0,fn=a[0];process_as_fn()}else if(sig=="[n,f]"){param_index=a[0],fn=a[1];process_as_fn()}return res});var mapify=function(target){var tt=tof(target);if(tt=="function"){var res=fp(function(a,sig){var that=this;if(sig=="[o]"){var map=a[0];each(map,function(i,v){target.call(that,i,v)})}else if(sig=="[o,f]"){var map=a[0];var callback=a[1];var fns=[];each(map,function(i,v){fns.push([target,[i,v]])});call_multi(fns,function(err_multi,res_multi){if(err_multi){callback(err_multi)}else{callback(null,res_multi)}})}else if(a.length>=2){target.apply(this,a)}});return res}else if(tt=="array"){var res={};if(arguments.length==1){each(target,function(i,v){res[v[0]]=v[1]})}else{var by_property_name=arguments[1];each(target,function(i,v){res[v[by_property_name]]=v})}return res}};var clone=fp(function(a,sig){var obj=a[0];if(a.l==1){var t=tof(obj);if(t=="array"){var res=[];each(obj,function(i,v){res.push(clone(v))});return res}else if(t=="undefined"){return undefined}else if(t=="string"){return obj}else if(t=="number"){return obj}else if(t=="function"){return obj}else if(t=="boolean"){return obj}else if(t=="null"){return obj}else{return extend(true,{},obj)}}else if(a.l==2&&tof(a[1])=="number"){var res=[];for(var c=0;c<a[1];c++){res.push(clone(obj))}return res}});var are_equal=function(){var a=arguments;if(a.length==0)return null;if(a.length==1){var t=jsgui.tof(a[0]);if(t=="array"&&a[0].length>1){for(var c=1,l=a[0].length;c<l;c++){if(!jsgui.are_equal(a[0][0],a[0][c]))return false}}else{return true}}if(a.length==2){var ts=jsgui.atof(a);if(ts[0]!=ts[1])return false;var t=ts[0];if(t=="string"||t=="number")return a[0]==a[1];if(t=="array"){if(a[0].length!=a[1].length)return false;for(var c=0,l=a[0].length;c<l;c++){if(!jsgui.are_equal(a[0][c],a[1][c]))return false}}else if(typeof a[0]=="object"){var merged_key_truth_map={};var c1=0;each(a[0],function(i,v){merged_key_truth_map[i]=true;c1++});var c2=0;each(a[1],function(i,v){merged_key_truth_map[i]=true;c2++});if(c1!=c2)return false;var objects_are_equal=true;each(merged_key_truth_map,function(i,v){if(!jsgui.are_equal(a[0][i],a[1][i])){objects_are_equal=false;return}});return objects_are_equal}else{return a[0]==a[1]}}if(a.length>2){var ts=jsgui.atof(a);if(!jsgui.are_equal(ts))return false;var o=a[0];for(var c=1,l=a.length;c<l;c++){if(a[c]!==o)return false}}return true};var set_vals=function(obj,map){each(map,function(i,v){obj[i]=v})};var ll_set=function(obj,prop_name,prop_value){var arr=prop_name.split(".");var c=0,l=arr.length;var i=obj._||obj,s;while(c<l){s=arr[c];if(typeof i[s]=="undefined"){if(c-l==-1){i[s]=prop_value}else{i[s]={}}}else{if(c-l==-1){i[s]=prop_value}}i=i[s];c++}return prop_value};var ll_get=function(a0,a1){if(a0&&a1){var i=a0._||a0;if(a1=="."){if(typeof i["."]=="undefined"){return undefined}else{return i["."]}}else{var arr=a1.split(".");var c=0,l=arr.length,s;while(c<l){s=arr[c];if(typeof i[s]=="undefined"){if(c-l==-1){}else{throw"object "+s+" not found"}}else{if(c-l==-1){return i[s]}}i=i[s];c++}}}};var truth=function(value){return value===true};var iterate_ancestor_classes=function(obj,callback){var ctu=true;var stop=function(){ctu=false};callback(obj,stop);if(obj._superclass&&ctu){iterate_ancestor_classes(obj._superclass,callback)}};var is_arr_of_t=function(obj,type_name){var t=tof(obj),tv;if(t=="array"){var res=true;each(obj,function(i,v){tv=tof(v);if(tv!=type_name)res=false});return res}else{return false}};var is_arr_of_arrs=function(obj){return is_arr_of_t(obj,"array")};var is_arr_of_strs=function(obj){return is_arr_of_t(obj,"string")};var input_processors={};var output_processors={};var is_constructor_fn=function(fn){return is_defined(fn.prototype)};var call_multiple_callback_functions=fp(function(a,sig){var arr_functions_params_pairs,callback,return_params=false;var num_parallel=1;if(a.l==2){arr_functions_params_pairs=a[0];callback=a[1]}if(a.l==3){if(sig=="[a,n,f]"){arr_functions_params_pairs=a[0];num_parallel=a[1];callback=a[2]}if(sig=="[a,f,b]"){arr_functions_params_pairs=a[0];callback=a[1];return_params=a[2]}}var res=[];var l=arr_functions_params_pairs.length;var c=0;var that=this;var count_unfinished=l;var num_currently_executing=0;var process=function(){num_currently_executing++;var pair=arr_functions_params_pairs[c];var context;var fn,params,fn_callback;var pair_sig=get_item_sig(pair);var t_pair=tof(pair);if(t_pair=="function"){fn=pair;params=[]}else{if(pair.length==1){}if(pair.length==2){if(tof(pair[1])=="function"){context=pair[0];fn=pair[1];params=[]}else{fn=pair[0];params=pair[1]}}if(pair.length==3){if(tof(pair[0])=="function"&&tof(pair[1])=="array"&&tof(pair[2])=="function"){fn=pair[0];params=pair[1];fn_callback=pair[2]}if(tof(pair[1])=="function"&&tof(pair[2])=="array"){context=pair[0];fn=pair[1];params=pair[2]}}if(pair.length==4){context=pair[0];fn=pair[1];params=pair[2];fn_callback=pair[3]}}var i=c;c++;var cb=function(err,res2){num_currently_executing--;count_unfinished--;if(err){var stack=(new Error).stack;throw err}else{if(return_params){res[i]=[params,res2]}else{res[i]=res2}if(fn_callback){fn_callback(null,res2)}if(c<l){if(num_currently_executing<num_parallel){process()}}else{if(count_unfinished<=0){callback(null,res)}}}};var arr_to_call=clone(params)||[];arr_to_call.push(cb);if(context){fn.apply(context,arr_to_call)}else{fn.apply(that,arr_to_call)}};if(arr_functions_params_pairs.length>0){while(c<l&&num_currently_executing<num_parallel){process()}}else{if(callback){callback(null,null)}}});var multi=call_multiple_callback_functions;var call_multi=call_multiple_callback_functions;var Fns=function(){var fns=[];fns.go=function(callback){call_multi(fns,callback)};return fns};var native_constructor_tof=function(value){if(value===String){return"String"}if(value===Number){return"Number"}if(value===Boolean){return"Boolean"}if(value===Array){return"Array"}if(value===Object){return"Object"}};var storage_map={};var get=function(key){return storage_map[key]};var set=function(key,value){storage_map[key]=value};var jsgui={Class:Class,each:each,eac:eac,is_array:is_array,is_dom_node:is_dom_node,is_ctrl:is_ctrl,extend:extend,clone:clone,get_truth_map_from_arr:get_truth_map_from_arr,arr_trim_undefined:arr_trim_undefined,get_map_from_arr:get_map_from_arr,arr_like_to_arr:arr_like_to_arr,tof:tof,atof:atof,is_defined:is_defined,stringify:stringify,functional_polymorphism:functional_polymorphism,fp:fp,arrayify:arrayify,mapify:mapify,are_equal:are_equal,get_item_sig:get_item_sig,set_vals:set_vals,truth:truth,trim_sig_brackets:trim_sig_brackets,ll_set:ll_set,ll_get:ll_get,iterate_ancestor_classes:iterate_ancestor_classes,is_constructor_fn:is_constructor_fn,is_arr_of_t:is_arr_of_t,is_arr_of_arrs:is_arr_of_arrs,is_arr_of_strs:is_arr_of_strs,input_processors:input_processors,output_processors:output_processors,call_multiple_callback_functions:call_multiple_callback_functions,call_multi:call_multi,native_constructor_tof:native_constructor_tof,Fns:Fns,get:get,set:set};jsgui.data_types_info=jsgui.data_types_info||{};var Node=Class.extend({init:function(spec){this.neighbours=spec.neighbours||[];this.value=spec.value},previous:function(){return this.neighbours[0]},next:function(){return this.neighbours[1]}});var nodify=function(fn){var res=function(val){if(val instanceof Node){return fn(val)}else{var node=new Node({value:val});return fn(node)}};return res};var Doubly_Linked_List=Class.extend({init:function(spec){this.first=null;this.last=null;this.length=0},each_node:function(callback){var node=this.first;var ctu=true;var stop=function(){ctu=false};while(node&&ctu){callback(node,stop);node=node.neighbours[1]}},each:function(callback){this.each_node(function(node,stop){callback(node.value,stop)})},remove:function(node){if(node.neighbours[0]){node.neighbours[0].neighbours[1]=node.neighbours[1]}else{this.first=node.neighbours[1]}if(node.neighbours[1]){node.neighbours[1].neighbours[0]=node.neighbours[0]}else{this.last=node.neighbours[0]}node.neighbours=[];if(node.parent==this){delete node.parent;this.length--}},insert_beginning:function(val){if(val instanceof Node){if(this.first==null){this.first=val;this.last=val;val.neighbours=[];if(val.parent!=this){val.parent=this;this.length++}}else{this.insert_before(val,this.first)}return val}else{var node=new Node({value:val});return this.insert_beginning(node)}},insert_before:function(val,node){if(val instanceof Node){val.neighbours=[node.neighbours[0],node];if(node.neighbours[0]==null){this.first=val}else{node.neighbours[0].neighbours[1]=val}node.neighbours[0]=val;if(val.parent!=this){val.parent=this;this.length++}return val}else{var new_node=new Node({value:val});return this.insert_before(new_node,node)}},insert_after:function(val,node){if(val instanceof Node){val.neighbours=[node,node.neighbours[1]];if(node.neighbours[1]==null){this.last=val}else{node.neighbours[1].neighbours[0]=val}node.neighbours[1]=val;if(val.parent!=this){val.parent=this;this.length++}return val}else{var new_node=new Node({value:val});return this.insert_after(new_node,node)}},push:function(val){if(val instanceof Node){if(this.last==null){this.insert_beginning(val)}else{return this.insert_after(val,this.last)}return val}else{var new_node=new Node({value:val});return this.push(new_node)}}});Doubly_Linked_List.Node=Node;var StiffArray=function(capacity){var m_public={items:new Array(capacity),count:0,first:function(){if(this.count==0)throw"StiffArray.first()";return this.items[0]},last:function(){if(this.count==0)throw"StiffArray.last()";return this.items[this.count-1]},add:function(item){if(this.count>=capacity)throw"StiffArray.add()";this.items[this.count++]=item},add_from:function(source){if(this.count+source.count>capacity)throw"StiffArray.add_from()";for(var i=0;i<source.count;i++)this.items[this.count++]=source.items[i]},insert:function(index,item){if(index<0||index>this.count)throw"StiffArray.insert(): index";if(this.count>=capacity)throw"StiffArray.insert(): overflow";for(var i=this.count;i>index;i--)this.items[i]=this.items[i-1];this.items[index]=item;this.count++},removeAt:function(index){if(index<0||index>=this.count)throw"StiffArray.removeAt()";this.count--;for(var i=index;i<this.count;i++)this.items[i]=this.items[i+1]},removeFirst:function(){this.removeAt(0)},removeLast:function(){this.removeAt(this.count-1)},copy_from:function(source,index,count){for(var i=0;i<count;i++){this.items[i]=source.items[i+index]}this.count=count},search_first:function(item){var cnt=this.count;var first=0;while(cnt>0){var step=Math.floor(cnt/2);var index=first+step;if(this.items[index]<item){first=index+1;cnt-=step+1}else{cnt=step}}if(first<this.count){return{found:this.items[first]==item,index:first}}return{found:false,index:first}},search_last:function(item){var cnt=this.count;var first=0;while(cnt>0){var step=Math.floor(cnt/2);var index=first+step;if(item>=this.items[index]){first=index+1;cnt-=step+1}else{cnt=step}}if(first>0&&first<=this.count){if(this.items[first-1]==item){return{found:true,index:first-1}}}return{found:false,index:first}},search_last_prefix:function(prefix){var prefix_length=prefix.length;var check_prefix=function(item){if(prefix_length>item.length)return false;return item.substr(0,prefix_length)==prefix};var cnt=this.count;var first=0;while(cnt>0){var step=Math.floor(cnt/2);var index=first+step;var item=this.items[index];if(prefix>item||check_prefix(item)){first=index+1;cnt-=step+1}else{cnt=step}}if(first>0&&first<=this.count){if(check_prefix(this.items[first-1])){return{found:true,index:first-1}}}return{found:false,index:first}},toString:function(){return this.items.slice(0,this.count).toString()}};return m_public};var B_Plus_Node=function(nodeCapacity){var m_public={isLeaf:false,parent:null,keys:new StiffArray(nodeCapacity+1),children:new StiffArray(nodeCapacity+2)};return m_public};var B_Plus_Leaf=function(nodeCapacity){var m_public={isLeaf:true,parent:null,keys:new StiffArray(nodeCapacity+1),values:new StiffArray(nodeCapacity+1),prevLeaf:null,nextLeaf:null};return m_public};var FindInfo=function(key,value,isPrefixSearch){isPrefixSearch=!!isPrefixSearch;var isKeyPresent=key!=undefined;var isValuePresent=value!=undefined;var prefixLength=0;if(isPrefixSearch){if(typeof key!="string"){isPrefixSearch=false}else{prefixLength=key.length}}return{key:key,value:value,isPrefixSearch:isPrefixSearch,leaf:null,index:-1,isKeyPresent:isKeyPresent,isValuePresent:isValuePresent,foundKey:function(){return this.leaf.keys.items[this.index]},foundValue:function(){return this.leaf.values.items[this.index]},prefix_length:prefixLength,check_prefix:function(){if(!isPrefixSearch)return false;if(this.index>=this.leaf.keys.count)return false;var keyToCheck=this.foundKey();if(this.prefix_length>keyToCheck.length)return false;return keyToCheck.substr(0,this.prefix_length)==this.key}}};var B_Plus_Tree=function(nodeCapacity){if(nodeCapacity===undefined)nodeCapacity=10;if(nodeCapacity<4)throw"B_Plus_Tree(): node capacity must be >= 4";var m_public={root:new B_Plus_Leaf(nodeCapacity),firstLeaf:null,lastLeaf:null,clear:function(){p_Clear()},insert:function(key,value){if(arguments.length==2){return p_Insert(key,value)}else{return p_Insert(key[0],key[1])}},remove:function(key,value){if(arguments.length==2){return p_Remove(key,value)}else{p_RemoveKey(key)}},findFirst:function(key,value){return p_FindFirst(key,value)},findFirstPrefix:function(prefix){return p_FindFirst(prefix,undefined,true)},findNext:function(findInfo){return p_FindNext(findInfo)},findLast:function(key,value){return p_FindLast(key,value)},findLastPrefix:function(prefix){return p_FindLast(prefix,undefined,true)},findPrevious:function(findInfo){return p_FindPrev(findInfo)},getValue:function(key){return p_GetValue(key)},setValue:function(key,value){p_SetValue(key,value)},count:function(key){if(arguments.length==1){return p_CountKey(key)}else{return p_Count()}},getCapacity:function(){return m_nodeMaxCount},each:function(callback){return p_each(callback)},keys:function(){return p_keys()},keys_and_values:function(){return p_keys_and_values()},get_by_prefix:function(prefix){return p_get_by_prefix(prefix)},get_keys_by_prefix:function(prefix){return p_get_keys_by_prefix(prefix)},get_values_by_key:function(key){return p_get_values_by_key(key)}};m_public.firstLeaf=m_public.root;m_public.lastLeaf=m_public.root;var m_nodeMaxCount=nodeCapacity;var m_nodeMinCount=Math.floor(m_nodeMaxCount/2);var p_Clear=function(){m_public.root=new B_Plus_Leaf(m_nodeMaxCount);m_public.firstLeaf=m_public.root;m_public.lastLeaf=m_public.root};var p_keys=function(){var res=[];_p_each_key(function(key){res.push(key)});return res};var p_keys_and_values=function(){var res=[];p_each(function(key,value){res.push([key,value])});return res};var _p_each_key=function(callback){var findInfo=p_FindFirst();while(findInfo!=null){var fk=findInfo.foundKey();callback(fk);findInfo=p_FindNext(findInfo)}};var p_each=function(callback){var findInfo=p_FindFirst();var doStop=false;while(findInfo!=null){var fk=findInfo.foundKey();var fv=findInfo.foundValue();callback(fk,fv,function(){doStop=true});if(doStop){findInfo=null}else{findInfo=p_FindNext(findInfo)}}};var p_Insert=function(key,value){var searchResult=searchLeaf(key);var leaf=searchResult.node;leaf.keys.insert(searchResult.index,key);leaf.values.insert(searchResult.index,value);if(leaf.keys.count>m_nodeMaxCount){if(leaf.prevLeaf!=null&&leaf.prevLeaf.keys.count<m_nodeMaxCount&&leaf.prevLeaf.parent==leaf.parent){rotateAmongLeavesToLeft(leaf.prevLeaf,leaf)}else if(leaf.nextLeaf!=null&&leaf.nextLeaf.keys.count<m_nodeMaxCount&&leaf.nextLeaf.parent==leaf.parent){rotateAmongLeavesToRight(leaf,leaf.nextLeaf)}else{splitLeaf(leaf)}}};var splitLeaf=function(leaf){var leftCount=m_nodeMinCount;var rightCount=leaf.keys.count-leftCount;var newRightLeaf=new B_Plus_Leaf(m_nodeMaxCount);newRightLeaf.parent=leaf.parent;newRightLeaf.keys.copy_from(leaf.keys,leftCount,rightCount);newRightLeaf.values.copy_from(leaf.values,leftCount,rightCount);leaf.keys.count=leftCount;leaf.values.count=leftCount;newRightLeaf.nextLeaf=leaf.nextLeaf;if(newRightLeaf.nextLeaf!=null)newRightLeaf.nextLeaf.prevLeaf=newRightLeaf;newRightLeaf.prevLeaf=leaf;leaf.nextLeaf=newRightLeaf;if(m_public.lastLeaf==leaf)m_public.lastLeaf=newRightLeaf;if(leaf.parent!=null){var leafIndex=calcChildIndex(leaf.parent,leaf);insertToParent(leaf.parent,newRightLeaf,newRightLeaf.keys.first(),leafIndex+1)}else{createNewRoot(leaf,newRightLeaf,newRightLeaf.keys.first())}};var createNewRoot=function(nodeLeft,nodeRight,key){var newRoot=new B_Plus_Node(m_nodeMaxCount);newRoot.keys.add(key);newRoot.children.add(nodeLeft);newRoot.children.add(nodeRight);nodeLeft.parent=newRoot;nodeRight.parent=newRoot;m_public.root=newRoot};var insertToParent=function(parentNode,newChildNode,newChildFirstKey,newChildIndex){parentNode.keys.insert(newChildIndex-1,newChildFirstKey);parentNode.children.insert(newChildIndex,newChildNode);newChildNode.parent=parentNode;if(parentNode.keys.count>m_nodeMaxCount){splitNode(parentNode)}};var splitNode=function(node){var newLeftCount=m_nodeMinCount;var newRightCount=m_nodeMaxCount-newLeftCount;var middleKey=node.keys.items[newLeftCount];var newRightNode=new B_Plus_Node(m_nodeMaxCount);newRightNode.keys.copy_from(node.keys,newLeftCount+1,newRightCount);newRightNode.children.copy_from(node.children,newLeftCount+1,newRightCount+1);node.keys.count=newLeftCount;node.children.count=newLeftCount+1;for(var i=0;i<newRightNode.children.count;i++)newRightNode.children.items[i].parent=newRightNode;if(node.parent==null){createNewRoot(node,newRightNode,middleKey)}else{var nodeIndex=calcChildIndex(node.parent,node);insertToParent(node.parent,newRightNode,middleKey,nodeIndex+1)}};var p_Remove=function(key,value){var searchResult=searchLeafValue(key,value);if(!searchResult.found)return false;removeFromLeaf(searchResult.node,searchResult.index);return true};var p_RemoveKey=function(key){while(true){var searchResult=searchLeaf(key);if(!searchResult.found)break;removeFromLeaf(searchResult.node,searchResult.index)}};var removeFromLeaf=function(leaf,index){leaf.keys.removeAt(index);leaf.values.removeAt(index);if(leaf.keys.count<m_nodeMinCount){if(leaf.prevLeaf!=null&&leaf.parent==leaf.prevLeaf.parent&&leaf.prevLeaf.keys.count>m_nodeMinCount){rotateAmongLeavesToRight(leaf.prevLeaf,leaf)}else if(leaf.nextLeaf!=null&&leaf.parent==leaf.nextLeaf.parent&&leaf.nextLeaf.keys.count>m_nodeMinCount){rotateAmongLeavesToLeft(leaf,leaf.nextLeaf)}else{mergeLeaf(leaf)}}return true};var mergeLeaf=function(leaf){if(leaf.parent==null){return}var leftCount=m_nodeMaxCount+1;var rightCount=m_nodeMaxCount+1;if(leaf.prevLeaf!=null&&leaf.prevLeaf.parent==leaf.parent){leftCount=leaf.prevLeaf.keys.count}if(leaf.nextLeaf!=null&&leaf.nextLeaf.parent==leaf.parent){rightCount=leaf.nextLeaf.keys.count}if(leftCount<rightCount){if(leftCount+leaf.keys.count>m_nodeMaxCount)throw"B_Plus_Tree.mergeLeaf(): leftCount";mergeLeaves(leaf.prevLeaf,leaf)}else{if(rightCount+leaf.keys.count>m_nodeMaxCount)throw"B_Plus_Tree.mergeLeaf(): rightCount";mergeLeaves(leaf,leaf.nextLeaf)}};var mergeLeaves=function(leafLeft,leafRight){leafLeft.keys.add_from(leafRight.keys);leafLeft.values.add_from(leafRight.values);leafLeft.nextLeaf=leafRight.nextLeaf;if(leafLeft.nextLeaf!=null)leafLeft.nextLeaf.prevLeaf=leafLeft;if(m_public.lastLeaf==leafRight)m_public.lastLeaf=leafLeft;var parent=leafRight.parent;var leafRightIndex=calcChildIndex(parent,leafRight);parent.keys.removeAt(leafRightIndex-1);parent.children.removeAt(leafRightIndex);if(parent.keys.count<m_nodeMinCount){mergeNode(parent)}};var mergeNode=function(node){var parent=node.parent;if(node.parent==null){if(node.keys.count==0){m_public.root=node.children.items[0];m_public.root.parent=null}return}var nodeIndex=calcChildIndex(parent,node);var leftSibling=nodeIndex>0?parent.children.items[nodeIndex-1]:null;var rightSibling=nodeIndex+1<parent.children.count?parent.children.items[nodeIndex+1]:null;if(leftSibling!=null&&leftSibling.keys.count>m_nodeMinCount){rotateAmongNodesToRight(leftSibling,node);return}if(rightSibling!=null&&rightSibling.keys.count>m_nodeMinCount){rotateAmongNodesToLeft(node,rightSibling);return}var leftCount=m_nodeMaxCount+1;var rightCount=m_nodeMaxCount+1;if(leftSibling!=null){leftCount=leftSibling.keys.count}if(rightSibling!=null){rightCount=rightSibling.keys.count}if(leftCount<rightCount){if(leftSibling==null)throw"B_Plus_Tree.mergeNode(): leftSibling";mergeNodes(leftSibling,node,nodeIndex)}else{if(rightSibling==null)throw"B_Plus_Tree.mergeNode(): rightSibling";mergeNodes(node,rightSibling,nodeIndex+1)}};var mergeNodes=function(nodeLeft,nodeRight,nodeRightIndex){var parent=nodeLeft.parent;for(var i=0;i<nodeRight.children.count;i++)nodeRight.children.items[i].parent=nodeLeft;nodeLeft.keys.add(nodeLeft.parent.keys.items[nodeRightIndex-1]);nodeLeft.keys.add_from(nodeRight.keys);nodeLeft.children.add_from(nodeRight.children);parent.keys.removeAt(nodeRightIndex-1);parent.children.removeAt(nodeRightIndex);if(parent.keys.count<m_nodeMinCount){mergeNode(parent)}};var p_FindFirst=function(key,value,isPrefixSearch){var findInfo=new FindInfo(key,value,isPrefixSearch);if(findInfo.isKeyPresent){if(findInfo.isPrefixSearch&&findInfo.isValuePresent)throw"B_Plus_Tree.p_FindFirst(): arguments error: isPrefixSearch, but value is present";var searchResult=findInfo.isValuePresent?searchLeafValue(key,value):searchLeaf(key);findInfo.leaf=searchResult.node;findInfo.index=searchResult.index;if(!searchResult.found){if(!findInfo.check_prefix()){return null}}}else{if(findInfo.isValuePresent)throw"B_Plus_Tree.findFirst(): arguments error: key is not present, but value is present";findInfo.leaf=m_public.firstLeaf;findInfo.index=0;if(findInfo.leaf.keys.count<=0)return null}return findInfo};var p_FindLast=function(key,value,isPrefixSearch){var findInfo=new FindInfo(key,value,isPrefixSearch);if(findInfo.isKeyPresent){if(findInfo.isPrefixSearch&&findInfo.isValuePresent)throw"B_Plus_Tree.p_FindLast(): arguments error: isPrefixSearch, but value is present";
if(findInfo.isPrefixSearch){var searchResult=searchLastLeafByPrefix(key);findInfo.leaf=searchResult.node;findInfo.index=searchResult.index;if(!searchResult.found){return null}}else{var searchResult=findInfo.isValuePresent?searchLastLeafValue(key,value):searchLastLeaf(key);findInfo.leaf=searchResult.node;findInfo.index=searchResult.index;if(!searchResult.found){return null}}}else{if(findInfo.isValuePresent)throw"B_Plus_Tree.findLast(): arguments error: key is not present, but value is present";findInfo.leaf=m_public.lastLeaf;findInfo.index=findInfo.leaf.keys.count-1;if(findInfo.index<0)return null}return findInfo};var findGoToNext=function(findInfo){findInfo.index++;if(findInfo.index>=findInfo.leaf.keys.count){findInfo.leaf=findInfo.leaf.nextLeaf;findInfo.index=0}return findInfo.leaf!=null};var findGoToPrev=function(findInfo){findInfo.index--;if(findInfo.index<0){findInfo.leaf=findInfo.leaf.prevLeaf;if(findInfo.leaf==null)return false;findInfo.index=findInfo.leaf.keys.count-1}return true};var p_FindNext=function(findInfo){while(true){if(!findGoToNext(findInfo))return null;if(findInfo.isPrefixSearch){if(!findInfo.check_prefix())return null}else{if(findInfo.isKeyPresent&&findInfo.key!=findInfo.foundKey())return null}if(findInfo.isValuePresent){if(findInfo.value==findInfo.foundValue())return findInfo}else{return findInfo}}};var p_FindPrev=function(findInfo){while(true){if(!findGoToPrev(findInfo))return null;if(findInfo.isPrefixSearch){if(!findInfo.check_prefix())return null}else{if(findInfo.isKeyPresent&&findInfo.key!=findInfo.foundKey())return null}if(findInfo.isValuePresent){if(findInfo.value==findInfo.foundValue())return findInfo}else{return findInfo}}};var p_get_values_by_key=function(key){var res=[];var findInfo=p_FindFirst(key);while(findInfo!=null){res.push(findInfo.foundValue());findInfo=p_FindNext(findInfo)}return res};var p_get_by_prefix=function(prefix){var res=[];var findInfo=m_public.findFirstPrefix(prefix);while(findInfo!=null){res.push([findInfo.foundKey(),findInfo.foundValue()]);findInfo=m_public.findNext(findInfo)}return res};var p_get_keys_by_prefix=function(prefix){var res=[];var findInfo=m_public.findFirstPrefix(prefix);while(findInfo!=null){res.push(findInfo.foundKey());findInfo=m_public.findNext(findInfo)}return res};var p_GetValue=function(key){var searchResult=searchLeaf(key);if(!searchResult.found)return null;return searchResult.node.values.items[searchResult.index]};var p_SetValue=function(key,value){var searchResult=searchLeaf(key);if(searchResult.found){removeFromLeaf(searchResult.node,searchResult.index)}p_Insert(key,value)};var p_Count=function(){var result=0;var leaf=m_public.firstLeaf;while(leaf!=null){result+=leaf.keys.count;leaf=leaf.nextLeaf}return result};var p_CountKey=function(key){var result=0;var findInfo=m_public.findFirst(key);while(findInfo!=null){result++;findInfo=m_public.findNext(findInfo)}return result};var rotateAmongNodesToLeft=function(leftNode,rightNode){var parent=rightNode.parent;var rightIndex=calcChildIndex(parent,rightNode);leftNode.keys.add(parent.keys.items[rightIndex-1]);parent.keys.items[rightIndex-1]=rightNode.keys.first();rightNode.keys.removeFirst();rightNode.children.first().parent=leftNode;leftNode.children.add(rightNode.children.first());rightNode.children.removeFirst()};var rotateAmongNodesToRight=function(leftNode,rightNode){var parent=rightNode.parent;var rightIndex=calcChildIndex(parent,rightNode);rightNode.keys.insert(0,parent.keys.items[rightIndex-1]);parent.keys.items[rightIndex-1]=leftNode.keys.last();leftNode.keys.removeLast();rightNode.children.insert(0,leftNode.children.last());rightNode.children.first().parent=rightNode;leftNode.children.removeLast()};var rotateAmongLeavesToLeft=function(leftLeaf,rightLeaf){var rightIndex=calcChildIndex(rightLeaf.parent,rightLeaf);leftLeaf.keys.add(rightLeaf.keys.first());leftLeaf.values.add(rightLeaf.values.first());rightLeaf.keys.removeFirst();rightLeaf.values.removeFirst();rightLeaf.parent.keys.items[rightIndex-1]=rightLeaf.keys.first()};var rotateAmongLeavesToRight=function(leftLeaf,rightLeaf){var rightIndex=calcChildIndex(rightLeaf.parent,rightLeaf);rightLeaf.keys.insert(0,leftLeaf.keys.last());rightLeaf.values.insert(0,leftLeaf.values.last());leftLeaf.keys.removeLast();leftLeaf.values.removeLast();rightLeaf.parent.keys.items[rightIndex-1]=rightLeaf.keys.first()};var calcChildIndex=function(node,child){var key=child.keys.first();var searchResult=node.keys.search_first(key);if(!searchResult.found){if(node.children.items[searchResult.index]!=child)throw"B_PlusTree.calcChildIndex(): 1";return searchResult.index}var index=searchResult.index;for(;;){if(node.children.items[index]==child)return index;index++;if(index>=node.children.count)break;if(node.keys.items[index-1]!=key)break}throw"B_PlusTree.calcChildIndex(): 2"};var searchLeaf=function(key){var doSearchLeaf=function(node,key){var searchResult=node.keys.search_first(key);if(node.isLeaf){return{node:node,found:searchResult.found,index:searchResult.index}}if(searchResult.found){var resultLeft=doSearchLeaf(node.children.items[searchResult.index],key);if(resultLeft.found)return resultLeft;return doSearchLeaf(node.children.items[searchResult.index+1],key)}else{return doSearchLeaf(node.children.items[searchResult.index],key)}};return doSearchLeaf(m_public.root,key)};var searchLastLeaf=function(key){var doSearchLastLeaf=function(node,key){var searchResult=node.keys.search_last(key);if(node.isLeaf){return{node:node,found:searchResult.found,index:searchResult.index}}if(searchResult.found){var resultRight=doSearchLastLeaf(node.children.items[searchResult.index+1],key);if(resultRight.found)return resultRight;return doSearchLastLeaf(node.children.items[searchResult.index],key)}else{return doSearchLastLeaf(node.children.items[searchResult.index],key)}};return doSearchLastLeaf(m_public.root,key)};var searchLastLeafByPrefix=function(prefix){var doSearchLastLeafByPrefix=function(node,prefix){var searchResult=node.keys.search_last_prefix(prefix);if(node.isLeaf){return{node:node,found:searchResult.found,index:searchResult.index}}if(searchResult.found){var resultRight=doSearchLastLeafByPrefix(node.children.items[searchResult.index+1],prefix);if(resultRight.found)return resultRight;return doSearchLastLeafByPrefix(node.children.items[searchResult.index],prefix)}else{return doSearchLastLeafByPrefix(node.children.items[searchResult.index],prefix)}};return doSearchLastLeafByPrefix(m_public.root,prefix)};var searchLeafValue=function(key,value){var searchResult=searchLeaf(key);if(!searchResult.found)return searchResult;var valueFound=false;var leaf=searchResult.node;var index=searchResult.index;for(;;){if(index>=leaf.values.count){leaf=leaf.nextLeaf;if(leaf==null)break;index=0}if(leaf.keys.items[index]!=key)break;if(leaf.values.items[index]==value){valueFound=true;break}index++}return{node:leaf,found:valueFound,index:index}};var searchLastLeafValue=function(key,value){var searchResult=searchLastLeaf(key);if(!searchResult.found)return searchResult;var valueFound=false;var leaf=searchResult.node;var index=searchResult.index;for(;;){if(index<0){leaf=leaf.prevLeaf;if(leaf==null)break;index=leaf.values.count-1}if(leaf.keys.items[index]!=key)break;if(leaf.values.items[index]==value){valueFound=true;break}index--}return{node:leaf,found:valueFound,index:index}};return m_public};B_Plus_Tree.FindInfo=FindInfo;var Sorted_KVS=Class.extend({init:function(spec){spec=spec||{};if(is_defined(spec.unique_keys))this.unique_keys=spec.unique_keys;this.tree=B_Plus_Tree(12)},clear:function(){this.tree.clear()},put:mapify(function(key,value){var insert_res=this.tree.insert(key,value)}),out:function(key){this.tree.remove(key)},get:function(key){return this.tree.get_values_by_key(key)},has:function(key){return this.key_count(key)>0},get_cursor:function(){},keys:function(){return this.tree.keys()},keys_and_values:function(){return this.tree.keys_and_values()},key_count:function(key){if(is_defined(key)){return this.tree.count(key)}else{return this.tree.count()}},get_keys_by_prefix:function(prefix){return this.tree.get_keys_by_prefix(prefix)},each:function(callback){return this.tree.each(callback)},get_by_prefix:function(prefix){return this.tree.get_by_prefix(prefix)}});var Ordered_KVS=Class.extend({init:function(){this.dll=new Doubly_Linked_List;this.node_map={}},length:function(){return this.dll.length},put:function(key,value){return this.push(key,value)},get:function(key){var kvs_node=this.node_map[key];if(kvs_node){return kvs_node.value}else{return undefined}},push:function(key,value){var node=this.dll.push(value);node.key=key;this.node_map[key]=node},out:function(key){var node=this.node_map[key];delete this.node_map[key];this.dll.remove(node)},each:function(callback){this.dll.each_node(function(node,stop){callback(node.key,node.value,stop)})},values:function(){var res=[];this.each(function(key,value){res.push(value)});return res},keys:function(){var res=[];this.each(function(key,value){res.push(key)});return res},keys_and_values:function(){var res=[];this.each(function(key,value){res.push([key,value])});return res}});var Ordered_String_List=Class.extend({init:function(){var arr=[];var dict_indexes={};var reindex_dict_indexes=function(){dict_indexes={};for(var c=0,l=arr.length;c<l;c++){dict_indexes[arr[c]]=c}};this.has=function(value){return typeof dict_indexes[value]!=="undefined"};this.put=function(value){if(this.has(value)){}else{var index=arr.length;arr.push(value);dict_indexes[value]=index}};this.out=function(value){if(this.has(value)){var idx=dict_indexes[value];arr.splice(idx,1);delete dict_indexes[value];for(var c=idx,l=arr.length;c<l;c++){var i=arr[c];dict_indexes[i]--}}};this.toggle=function(value){if(this.has(value)){this.out(value)}else{this.put(value)}};this.move_value=function(value,index){if(this.has(value)&&dict_indexes[value]!=index){var old_index=dict_indexes[value];arr.splice(old_index,1);arr.splice(index,0,value);if(index<old_index){dict_indexes[arr[index]]=index;for(var c=index+1;c<=old_index;c++){dict_indexes[arr[c]]++}}else if(index>old_index){dict_indexes[arr[index]]=index;for(var c=old_index;c<index;c++){dict_indexes[arr[c]]--}}}};this._index_scan=function(){for(var c=0,l=arr.length;c<l;c++){console.log("c "+c+" arr[c] "+arr[c]+" idx "+dict_indexes[arr[c]])}};this.toString=function(){var res=arr.join(" ");return res};this.toString.stringify=true;this.set=fp(function(a,sig){if(sig=="[s]"){arr=a[0].split(" ");reindex_dict_indexes()}});var a=arguments;if(a.length==1){var spec=a[0];if(tof(spec)=="string"){this.set(spec)}}}});var Data_Structures={Doubly_Linked_List:Doubly_Linked_List,B_Plus_Tree:B_Plus_Tree,Sorted_KVS:Sorted_KVS,Ordered_KVS:Ordered_KVS,Ordered_String_List:Ordered_String_List};var Constraint=Class.extend({init:function(spec){if(tof(spec)=="string"){}}});var obj_matches_constraint=function(obj,constraint){if(tof(constraint)=="string"){constraint=constraint_from_str(constraint);return constraint.match(obj)}};var Data_Object_Constraint=Constraint.extend({init:function(spec){this.__data_type="data_object_constraint"}});var Data_Object_Def_Constraint=Constraint.extend({init:function(spec){this.__data_type="data_object_def_constraint";if(tof(spec)==="object"){this.data_def=spec}},match:function(value){var that=this;var tv=tof(value);if(tv=="object"){var allMatch=true;each(this.data_def,function(field_name,field_def,stop){var match=object_matches_def(value[field_name],field_def);allMatch=allMatch&&match;if(!allMatch)stop()});return allMatch}return false}});var Field_Constraint=Constraint.extend({init:function(spec){this.__data_type="field_constraint"}});var Field_Data_Type_Constraint=Field_Constraint.extend({init:function(spec){this._super(spec)}});var Text_Constraint=Field_Data_Type_Constraint.extend({init:function(spec){this._super(spec);if(is_defined(spec.length)){this.length=spec.length}},match:function(v){if(is_defined(this.length)){return tof(v)=="string"&&v.length<=this.length}else{return tof(v)=="string"}},to_info_obj:function(){if(is_defined(this.length)){return["text",this.length]}else{return"text"}}});var Not_Null_Constraint=Field_Constraint.extend({init:function(spec){this._super(spec)},match:function(v){return is_defined(v)&&v!=null}});var Guid_Constraint=Field_Data_Type_Constraint.extend({init:function(spec){this._super(spec)},match:function(v){if(tof(v)==="string"){var reg=/^{[A-Fa-f0-9]{8}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{12}}$/;return reg.test(v)}return false},to_info_obj:function(){return"guid"}});var Number_Constraint=Field_Data_Type_Constraint.extend({init:function(spec){this._super(spec)},match:function(v){return tof(v)=="number"},to_info_obj:function(){return"number"}});var Int_Constraint=Number_Constraint.extend({init:function(spec){this._super(spec)},match:function(v){return tof(v)=="number"&&parseInt(v)===v},to_info_obj:function(){return"int"}});var Collection_Constraint=Constraint.extend({init:function(spec){this.__data_type="collection_constraint"}});var object_matches_def=function(value,def){var tv=tof(value);if(tv==def){return true}return false};var Collection_Data_Def_Constraint=Collection_Constraint.extend({init:function(spec){this._super();if(tof(spec)==="object"){this.data_def=spec}this._constraint_type="data_def"},match:function(value){var that=this;var tv=tof(value);if(tv=="object"){var allMatch=true;each(this.data_def,function(field_name,field_def,stop){var match=object_matches_def(value[field_name],field_def);allMatch=allMatch&&match;if(!allMatch)stop()});return allMatch}}});var Collection_Data_Type_Constraint=Collection_Constraint.extend({init:function(spec){this._super();if(tof(spec)==="function"){this.data_type_constructor=spec}this._constraint_type="data_type"},match:fp(function(a,sig){var ta0=tof(a[0]);if(ta0=="number"){if(this.data_type_constructor===Number)return true}if(ta0=="string"){if(this.data_type_constructor===String)return true}if(this.data_type_constructor&&a[0]instanceof this.data_type_constructor){return true}return false})});var Unique_Constraint=Collection_Constraint.extend({init:function(spec){this._super(spec);this._constraint_type="unique";if(is_defined(spec.fields))this.fields=spec.fields;if(tof(this.fields)=="array"){this._sorted_fields=clone(this.fields).sort()}}});var from_obj=fp(function(a,sig){if(sig=="[s]"){return constraint_from_str(a[0])}if(a.l==1&&tof(a[0])=="array"){var obj=a[0];var obj_sig=get_item_sig(obj,1);if(obj_sig=="[s,n]"){var data_type_name=obj[0];var length=obj[1];if(data_type_name=="text"){var constraint=new Text_Constraint({length:length});return constraint}}if(obj_sig=="[s,s]"){var constraint_type=obj[0];if(constraint_type=="unique"){var field_name=obj[1];var constraint=new Unique_Constraint({fields:field_name});return constraint}if(constraint_type=="text"){}}}});var constraint_from_str=function(str){var rx_specified_length_text=/^text\((\d+)\)$/;var match_slt=str.match(rx_specified_length_text);if(match_slt){var length=parseInt(match_slt[1]);var constraint=new Text_Constraint({length:length});return constraint}if(str==="text"){var constraint=new Text_Constraint({});return constraint}if(str==="int"){var constraint=new Int_Constraint({});return constraint}if(str==="number"){var constraint=new Number_Constraint({});return constraint}if(str==="guid"){var constraint=new Guid_Constraint({});return constraint}};Constraint.from_obj=from_obj;Constraint.from_str=constraint_from_str;Constraint.obj_matches_constraint=obj_matches_constraint;Constraint.Not_Null=Not_Null_Constraint;Constraint.Unique=Unique_Constraint;Constraint.Data_Object_Def_Constraint=Data_Object_Def_Constraint;Constraint.Collection_Data_Type=Collection_Data_Type_Constraint;Constraint.Collection_Data_Def=Collection_Data_Def_Constraint;Constraint.Field_Data_Type=Field_Data_Type_Constraint;Constraint.Guid=Guid_Constraint;var data_value_index=0;var data_value_abbreviation="val";jsgui.__data_id_method="init";var obj_matches_constraint=Constraint.obj_matches_constraint;var native_constructor_tof=jsgui.native_constructor_tof;var value_as_field_constraint=Constraint.value_as_field_constraint;var Ordered_String_List=Data_Structures.Ordered_String_List;var parse_field_text=function(field_text){field_text=field_text.replace(/not null/g,"not_null");var is_unique=false;var is_indexed=false;var is_not_null=false;var is_read_only=false,is_pk=false;var field_words=field_text.split(" ");var flag_words=[];var str_data_type;var word;for(var c=0,l=field_words.length;c<l;c++){word=field_words[c];if(c<l-1){flag_words.push(word)}else{str_data_type=word}}each(flag_words,function(i,v){if(v=="unique"){is_unique=true}if(v=="pk"){is_pk=true}if(v=="indexed"){is_indexed=true}if(v=="not_null"){is_not_null=true}if(v=="readonly"||v=="read_only"||v=="read-only"){is_read_only=true}});var data_type=parse_data_type(str_data_type);var res={data_type:data_type};if(is_read_only){res.read_only=is_read_only}if(is_pk){res.pk=is_pk}if(is_unique){res.unique=is_unique}if(is_not_null){res.not_null=is_not_null}if(is_indexed){res.indexed=is_indexed}return res};var parse_data_type=function(data_type_text){var rx_dt=/^(([a-z]|[A-Z]|_)\w*)(\((\d+)\))?/;var match=data_type_text.match(rx_dt);if(match){var dt_name=match[1];var dt_length=parseInt(match[4]);if(is_defined(dt_length)&!isNaN(dt_length)){return[dt_name,dt_length]}else{return dt_name}}};var field_obj_to_text=function(field_obj){var words=[];if(field_obj.unique){words.push("unique")}if(field_obj.pk){words.push("pk")}if(field_obj.indexed){words.push("indexed")}if(field_obj.not_null){words.push("not_null")}if(field_obj.read_only){words.push("read_only")}if(tof(field_obj))return words.join(" ")};var Fields_Collection=Class.extend({init:function(spec){this.okvs=new Data_Structures.Ordered_KVS},_get_field_index:function(field_name){},set:fp(function(a,sig){var that=this;if(sig=="[a]"){var item_or_arr=a[0];var ioa_sig=get_item_sig(item_or_arr,2);if(ioa_sig=="[s,s]"){var field_name=item_or_arr[0];var field_str_def=item_or_arr[1];var field_obj=parse_field_text(field_str_def);var field_arr=[field_name,field_str_def,field_obj];this.set(field_arr)}else if(ioa_sig=="[s,f]"){var field_name=item_or_arr[0];var field_str_def="Class";var field_obj=item_or_arr[1];var field_arr=[field_name,field_str_def,field_obj];this.okvs.put(field_name,field_arr)}else if(ioa_sig=="[s,s,o]"){var field_name=item_or_arr[0];var field_str_def=item_or_arr[1];var field_obj=item_or_arr[2];var field_arr=[field_name,field_str_def,field_obj];this.okvs.put(field_name,field_arr)}else{var rx_test_sig_default_value=/\[n,\[s,s,\w\]\]/;if(ioa_sig=="[n,[s,s]]"){var field_def=item_or_arr[1];var field_name=field_def[0];var field_type_name=field_def[1];if(field_type_name=="collection"){if(field_item_type_name){var field_arr=[field_name,[field_type_name,field_item_type_name]]}else{var field_arr=[field_name,field_type_name]}this.okvs.put(field_name,field_arr)}else{var field_arr=[field_name,field_type_name];this.okvs.put(field_name,field_arr)}}else if(ioa_sig.match(rx_test_sig_default_value)){var field_def=item_or_arr[1];var field_name=field_def[0];var field_type_name=field_def[1];var field_default_value=field_def[2];if(field_type_name=="collection"){throw"Default values for Collection not supported";if(field_item_type_name){var field_arr=[field_name,[field_type_name,field_item_type_name]]}else{var field_arr=[field_name,field_type_name]}this.okvs.put(field_name,field_arr)}else{var field_arr=[field_name,field_type_name,field_default_value];this.okvs.put(field_name,field_arr)}}if(ioa_sig=="[s,[s,s]]"){var field_name=item_or_arr[0];var field_def=item_or_arr[1];var field_type_name=field_def[0];var field_item_type_name=field_def[1];if(field_type_name=="collection"){var field_arr=[field_name,[field_type_name,field_item_type_name]];this.okvs.put(field_name,field_arr)}}else{if(ioa_sig=="[]"){}if(ioa_sig=="[o]"){throw"stop"}else{if(ioa_sig=="[s,o]"){var fieldName=item_or_arr[0];var fieldDef=item_or_arr[1];var field_arr=[fieldName,["data_object",fieldDef]];this.okvs.put(fieldName,field_arr)}if(ioa_sig=="[s,[o]]"){var fieldName=item_or_arr[0];var fieldItemDef=item_or_arr[1][0];var field_arr=[fieldName,["collection",fieldItemDef]];this.okvs.put(fieldName,field_arr)}if(ioa_sig=="[s,~C]"){var t_abstract=native_constructor_tof(item_or_arr[1]._type_constructor);if(t_abstract){var field_name=item_or_arr[0];var field_arr=[field_name,["collection",t_abstract.toLowerCase()]];this.okvs.put(field_name,field_arr)}else{var field_name=item_or_arr[0];var field_arr=[field_name,"collection"];this.okvs.put(field_name,field_arr)}}}}var aoa=is_arr_of_arrs(item_or_arr);if(aoa){each(item_or_arr,function(i,v){that.set(v)})}}}if(sig=="[o]"){var this_set_call=this.set.call,a0=a[0];for(i in a0){this.set.call(this,[i,a0[i]])}}if(a.l>1){this.set(a)}}),get:function(a0){var ta0=typeof a0;if(ta0=="undefined"){return this.okvs.values()}else if(ta0=="string"){return this.okvs.get(a0)}},fields:function(){return this.get.apply(this,arguments)},out:function(key){this.okvs.out(key)},clear:function(){}});Fields_Collection.parse_field_text=parse_field_text;Fields_Collection.parse_data_type=parse_data_type;var data_value_index=0;var data_value_abbreviation="val";jsgui.__data_id_method="init";var obj_matches_constraint=Constraint.obj_matches_constraint;var native_constructor_tof=jsgui.native_constructor_tof;var value_as_field_constraint=Constraint.value_as_field_constraint;var Ordered_String_List=Data_Structures.Ordered_String_List;var Mini_Context=jsgui.Class.extend({init:function(spec){var map_typed_counts={};var typed_id=function(str_type){throw"stop Mini_Context typed id";var res;if(!map_typed_counts[str_type]){res=str_type+"_0";map_typed_counts[str_type]=1}else{res=str_type+"_"+map_typed_counts[str_type];map_typed_counts[str_type]++}return res};this.new_id=typed_id},make:function(abstract_object){if(abstract_object._abstract){var constructor=abstract_object.constructor;console.log("constructor "+constructor);var aos=abstract_object._spec;aos.abstract=null;aos.context=this;var res=new constructor(aos);r;return res}else{throw"Object must be abstract, having ._abstract == true"}}});var Evented_Class=Class.extend({raise_event:fp(function(a,sig){var that=this;if(sig=="[s]"){var target=this;var event_name=a[0];var bgh=this._bound_general_handler;var be=this._bound_events;if(be){var bei=be[event_name];if(tof(bei)=="array"){var res=[];each(bei,function(i,v){res.push(v.call(target))});return res}}}if(a.l>=2){var target=this;var event_name=a[0];var additional_args=[];for(var c=1,l=a.l;c<l;c++){additional_args.push(a[c])}var be=this._bound_events;if(be){var bei=be[event_name];if(tof(bei)=="array"){if(bei.length>0){var res=[];each(bei,function(i,v){res.push(v.apply(target,additional_args))});return res}else{return false}}}}return[]}),raise:function(){return this.raise_event.apply(this,arguments)},trigger:function(){return this.raise_event.apply(this,arguments)},__add_event_listener:function(eventName,handler){var a=arguments;if(a.length==1){handler=eventName;eventName=null}if(is_defined(eventName)){this._bound_events=this._bound_events||{};if(!this._bound_events[eventName])this._bound_events[eventName]=[];var bei=this._bound_events[eventName];if(tof(bei)=="array"){bei.push(handler)}}},add_event_listener:fp(function(a,sig){if(sig=="[f]"){var stack=(new Error).stack;console.log(stack);throw"stop";this._bound_general_handler=this._bound_general_handler||[];if(tof(this._bound_general_handler)=="array"){this._bound_general_handler.push(a[0])}}if(sig=="[s,f]"){var event_name=a[0],fn_listener=a[1];this._bound_events=this._bound_events||{};if(!this._bound_events[event_name])this._bound_events[event_name]=[];var bei=this._bound_events[event_name];if(tof(bei)=="array"){bei.push(fn_listener)}}}),on:function(){return this.add_event_listener.apply(this,arguments)},remove_event_listener:function(event_name,fn_listener){if(this._bound_events){var bei=this._bound_events[event_name]||[];var tbei=tof(bei);if(tbei=="array"){var c=0,l=bei.length,found=false;while(!found&&c<l){if(bei[c]===fn_listener){found=true}else{c++}}if(found){bei.splice(c,1)}}}},off:function(){return this.remove_event_listener.apply(this,arguments)},one:function(event_name,fn_handler){var inner_handler=function(e){fn_handler.call(this,e);this.off(event_name,inner_handler)};this.on(event_name,inner_handler)}});var Data_Value=Evented_Class.extend({init:function(spec){if(spec&&spec.context){this._context=spec.context}if(spec){}if(spec&&is_defined(spec.value)){this._=spec.value}if(jsgui.__data_id_method=="init"){if(this._context){}else{}}this.__type="data_value";this._bound_events={};this._relationships={}},get:function(){return this._},value:function(){return this.get()},toObject:function(){return this._},set:function(val){var old_val=this._;this._=val;this.raise("change",{old:old_val,value:val});return val},toString:function(){return this.get()},stringify:function(){var val=this.get();var tval=typeof val;if(tval=="string"){return'"'+val+'"'}else{return val}},_id:function(){if(this.__id)return this.__id;if(this._context){this.__id=this._context.new_id(this.__type_name||this.__type)}else{if(!is_defined(this.__id)){throw"DataValue should have context";this.__id=new_data_value_id()}}return this.__id},parent:fp(function(a,sig){var obj,index;if(a.l==0){return this._parent}if(a.l==1){obj=a[0];if(!this._context&&obj._context){this._context=obj._context}var relate_by_id=function(that){var obj_id=obj._id();that._relationships[obj_id]=true};var relate_by_ref=function(that){that._parent=obj};relate_by_ref(this)}if(a.l==2){obj=a[0];index=a[1];if(!this._context&&obj._context){this._context=obj._context}this._parent=obj;this._index=index}if(is_defined(index)){}else{}})});var is_js_native=function(obj){var t=tof(obj);return t=="number"||t=="string"||t=="boolean"||t=="array"};var Data_Object=Evented_Class.extend({init:function(spec){if(!spec)spec={};if(spec.abstract===true){this._abstract=true;var tSpec=tof(spec);if(tSpec=="function"){this._type_constructor=spec}if(tSpec=="object"){this._spec=spec}}else{var that=this;this._initializing=true;if(spec.context){this._context=spec.context}if(spec._id){this.__id=spec._id}if(!this.__type){this.__type="data_object"}if(!is_defined(this.__id)&&jsgui.__data_id_method=="init"){if(this._context){this.__id=this._context.new_id(this.__type_name||this.__type)}else{}}if(!this.hasOwnProperty("_")){this._={}}if(is_defined(this.__type_name)){spec={set:spec}}var chained_fields=get_chained_fields(this.constructor);var chained_fields_list=chained_fields_to_fields_list(chained_fields);if(chained_fields_list.length>0){this.fc=new Fields_Collection({});this.fc.set(chained_fields_list);var do_connect=this.using_fields_connection();if(do_connect){var arr_field_names=[],field_name;each(chained_fields,function(i,field_info){field_name=field_info[1][0];arr_field_names.push(field_name)});this.connect_fields(arr_field_names)}}var chained_field_name;each(spec,function(i,v){if(typeof that[i]=="function"){that[i](v)}else{if(chained_fields_list.length>0){var tcf,chained_field;for(var c=0,l=chained_fields_list.length;c<l;c++){chained_field=chained_fields_list[c];tcf=tof(chained_field);if(tcf=="string"){chained_field_name=chained_field}else if(tcf=="array"){chained_field_name=chained_field[0]}if(chained_field_name==i){that.set(i,v)}}}}});if(is_defined(spec.event_bindings)){throw"16) stop";each(spec.event_bindings,function(event_name,v){if(tof(v)=="array"){each(v,function(event_name,fn_event){if(tof(fn_event)=="function"){this.add_event_listener(event_name,fn_event)}})}else if(tof(v)=="function"){this.add_event_listener(event_name,v)}})}var spec_reserved=["parent","event_bindings","load_array"];var map_spec_reserved=get_truth_map_from_arr(spec_reserved);if(spec.constraint)that.constraint(spec.constraint);if(is_defined(spec.parent)){this.set("parent",spec.parent)}if(this._context){this.init_default_events()}this._initializing=false}},init_default_events:function(){},data_def:fp(function(a,sig){if(sig=="[o]"){}}),stringify:function(){var res=[];res.push("Data_Object("+stringify(this._)+")");return res.join("")},toObject:function(){var res={};each(this._,function(i,v){if(v.toObject){res[i]=v.toObject()}else{res[i]=v}});return res},using_fields_connection:function(){var res=false;iterate_ancestor_classes(this.constructor,function(a_class,stop){if(is_defined(a_class._connect_fields)){res=a_class._connect_fields;stop()}});return res},connect_fields:fp(function(a,sig){var that=this;if(a.l==1&&tof(a[0])=="array"){var arr_fields=a[0];each(a[0],function(i,v){that.connect_fields(v)})}if(sig=="[s]"){this[a[0]]=function(a1){if(typeof a1=="undefined"){return that.get(a[0])}else{return that.set(a[0],a1)}}}if(sig=="[o]"){throw"16) stop"}}),parent:fp(function(a,sig){var obj,index;if(a.l==0){return this._parent}if(a.l==1){obj=a[0];if(!this._context&&obj._context){this._context=obj._context}var relate_by_id=function(that){var obj_id=obj._id();that._relationships[obj_id]=true};var relate_by_ref=function(that){that._parent=obj};relate_by_ref(this)}if(a.l==2){obj=a[0];index=a[1];if(!this._context&&obj._context){this._context=obj._context}this._parent=obj;this._index=index}if(is_defined(index)){}else{}}),_fp_parent:fp(function(a,sig){if(a.l==0){var arr_parents=[];var tri;each(this._relationships,function(relative_id,relationship_info){tri=tof(relationship_info);console.log("relative_id "+relative_id);if(tri=="number"){throw"Relationships system needs more work here. Had been using the map of all many objects, which has been removed for web server performance reasons."}else{if(tri=="data_object"||tri=="collection"){arr_parents.push(relationship_info)}}});if(arr_parents.length==1){return arr_parents[0]}else if(arr_parents.length>1){return arr_parents}}else{if(sig=="[D]"){var parent=a[0];console.log("[D] parent io Data_Object "+parent instanceof Data_Object);if(parent._context)this._context=parent._context;var use_parent_id=function(){var p_id=parent._id();var tp=tof(parent);if(tp=="data_object"){this._relationships=this._relationships||{};this._relationships[p_id]=parent}if(tp=="collection"){throw"Required: position in array of item"}};var use_parent_ref=function(){}}if(sig=="[D,n]"){var parent=a[0];var p_id=parent._id();var position_in_array=a[1];if(parent._context)this._context=parent._context;this._parents=this._parents||{};this._parents[p_id]=[parent,position_in_array]}}}),_id:function(){if(this.__id)return this.__id;if(this._context){this.__id=this._context.new_id(this.__type_name||this.__type)}else{if(this._abstract){return undefined}else if(!is_defined(this.__id)){throw"stop, currently unsupported.";this.__id=new_data_object_id();console.log("!!! no context __id "+this.__id)}}return this.__id},fields:fp(function(a,sig){var that=this;if(a.l==0){var fields_collection=this.fc;var res;if(fields_collection){res=fields_collection.okvs.values()}else{res=[]}return res}if(sig=="[s]"){var fc=this.fc;var res=fc.get(a[0]);return res}if(sig=="[o]"){each(a[0],function(i,v){that.set_field(i,v)},that)}}),constraints:fp(function(a,sig){if(a.l==0){}if(sig=="[o]"){var field_constraints=a[0];this._field_constraints=field_constraints}if(a.l==2&&tof(a[0])=="string"){}}),matches_field_constraint:fp(function(a,sig){if(sig=="[s,s]"){var field_name=a[0];if(tof(a[1])=="string"){var str_constraint=a[1];var field_val=this.get(field_name);return obj_matches_constraint(field_val,str_constraint)}if(tof(a[1])=="array"){throw"Multiple constraints not yet implemented here"}}}),obj_matches_field_constraints:function(obj){var that=this;var matches=true;each(this._field_constraints,function(i,v){matches=matches&&obj.matches_field_constraint(i,v)});return matches},read_only:arrayify(fp(function(a,sig){var mro=this._map_read_only=this._map_read_only||{};var field_name=a[0];if(sig=="[s]"){mro[field_name]=true}if(sig=="[s,b]"){var bool_is_read_only=a[1];if(bool_is_read_only){return this.read_only(field_name)}else{mro[field_name]=null}}})),set_field:fp(function(a,sig){this.fc=this.fc||new Fields_Collection;
return this.fc.set.apply(this.fc,a)}),set_field_data_type_constraint:function(field_name,data_type_constructor){var fmc=this._map_field_constraints=this._map_field_constraints||{};var fmfc=fmc[field_name];if(fmfc){var deletion_index;each(fmfc,function(i,v){if(v instanceof Constraint.Field_Data_Type){if(v.data_type_constructor===data_type_constructor){}else{deletion_index=i}}});if(is_defined(deletion_index)){fmfc.splice(deletion_index,1)}}},get_field_data_type_constraint:function(field_name){var fmc=this._map_field_constraints;if(fmc){var fmfc=fmc[field_name];if(fmfc){each(fmfc,function(i,v){if(v instanceof Constraint.Field_Data_Type){return v}})}}},ensure_field_constraint:fp(function(a,sig){if(sig=="[s,o]"){var field_name=a[0];var field_info=a[1];this._map_field_constraints=this._map_field_constraints||{};this._map_field_constraints[field_name]=this._map_field_constraints[field_name]||[];var fc_item_arr=this._map_field_constraints[field_name];var dt_info=field_info.data_type;var new_dt_constraint=Constraint.from_obj(dt_info);if(!is_defined(new_dt_constraint)){}else{var dt_constraint;if(fc_item_arr.length>0){var dt_constraints=[];each(fc_item_arr,function(i,constraint_item){if(constraint_item instanceof Constraint.Field_Data_Type){var constraint_info=constraint_item.to_info_obj();console.log("constraint_info "+stringify(constraint_info));console.log("field_info "+stringify(field_info));var stack=(new Error).stack;console.log(stack);throw"6) it is! stop, check to see if it is a Field_Data_Type_Constraint, use instanceOf"}})}else{fc_item_arr.push(new_dt_constraint)}}}}),matches_field_constraints:fp(function(a,sig){if(a.l==0){return this.matches_field_constraints(this._field_constraints)}if(sig=="[D]"){var fcs=this._field_constraints;var obj=a[0];var all_match=true,obj_field_value,matches;each(fcs,function(field_name,constraint){obj_field_value=obj.get(field_name);matches=obj_matches_constraint(obj_field_value,constraint);all_match=all_match&&matches});return all_match}if(sig=="[o]"){return data_object_matches_field_constraints(this,a[0])}}),____requires:fp(function(a,spec){if(a.l==0){return this._requirements}}),_____meets_requirements:fp(function(a,sig){var requirements=this._requirements;if(!requirements){return true}else{if(sig=="[s]"){var property_name=a[0]}}}),each:function(callback){each(this._,callback)},position_within:function(parent){var p_id=parent._id();if(this._parents&&is_defined(this._parents[p_id])){var parent_rel_info=this._parents[p_id];var pos_within=parent_rel_info[1];return pos_within}},remove_from:function(parent){var p_id=parent._id();if(this._parents&&is_defined(this._parents[p_id])){var parent=this._parents[p_id][0];var pos_within=this._parents[p_id][1];var item=parent._arr[pos_within];parent.remove(pos_within);delete this._parents[p_id]}},_____check_requirements:fp(function(a,sig){if(a.l==0){}if(sig=="[s]"){var property_name=a[0]}if(a.l==1&&a[0]===true){}}),load_from_spec:function(spec,arr_item_names){var that=this;each(arr_item_names,function(i,v){var spec_item=spec[v];if(is_defined(spec_item)){that["set"](v,spec_item)}})},mod_link:function(){return jsgui},value:function(){var res={};this.each(function(i,v){if(typeof v.value=="function"){res[i]=v.value()}else{res[i]=v}});return res},get:fp(function(a,sig){if(is_defined(this.__type_name)){if(a.l==0){var output_obj=jsgui.output_processors[this.__type_name](this._);return output_obj}else{throw"not yet implemented"}}else{if(sig=="[s,f]"){throw"Asyncronous access not allowed on Data_Object get.";var res=this.get(a[0]);var callback=a[1];if(typeof res=="function"){res(callback)}else{return res}}if(sig=="[s]"){var fc=this.fc;var field_name=a[0];var field;if(fc){field=fc.get(a[0])}if(field_name.indexOf(".")>-1){var arr_field_names=field_name.split(".");var level=0,l=arr_field_names.length;var current_obj=this,new_obj,fname;while(level<l){fname=arr_field_names[level];if(!current_obj){return undefined}new_obj=current_obj.get(fname);level++;current_obj=new_obj}return current_obj}if(field){if(!this._[field_name]){var sig_field=get_item_sig(field,20);if(sig_field=="[s,s,f]"){var field_name=field[0];var fieldStrType=field[1];var fieldDef=field[2];if(fieldDef==String){var dval=new Data_Value({context:this._context});this._[field_name]=dval;return this._[field_name]}else if(fieldDef==Number){var dval=new Data_Value({context:this._context});this._[field_name]=dval;return this._[field_name]}else if(fieldStrType=="Class"){var FieldConstructor=fieldDef;var nObj=new FieldConstructor({context:this._context});this._[field_name]=nObj;return this._[field_name]}}if(sig_field=="[s,[s,u]]"){var stack=(new Error).stack;console.log(stack)}if(sig_field=="[s,s,o]"){var field_name=field[0];var field_type_name=field[1];var field_info=field[2];if(field_type_name=="collection"){this._[field_name]=new jsgui.Collection({context:this._context});return this._[field_name]}else{if(field_type_name=="data_object"){var dobj=new Data_Object({context:this._context});this._[field_name]=dobj;dobj.parent(this);return this._[field_name]}if(field_type_name=="ordered_string_list"){var osl=new Ordered_String_List;this._[field_name]=osl;return this._[field_name]}else if(field_type_name=="string"){var dv=new Data_Value({context:this._context});this._[field_name]=dv;dv.parent(this);return this._[field_name]}else{var dt=field_info.data_type;var dt_sig=get_item_sig(dt,4);if(dt_sig=="[s,n]"){var data_type_name=dt[0];var data_type_length=dt[1];if(data_type_name=="text"){var dVal=new Data_Value({context:this._context});this._[field_name]=dVal;return this._[field_name]}}else if(dt_sig=="s"){var data_type_name=dt;if(data_type_name=="int"){var dVal=new Data_Value({context:this._context});this._[field_name]=dVal;return this._[field_name]}}else{var dtoc=this.mod_link().ensure_data_type_data_object_constructor(field_type_name);var field_val=new dtoc({context:this._context});field_val.parent(this);this._[field_name]=field_val;return this._[field_name]}}}}else if(sig_field=="[s,s]"){var field_name=field[0];var field_type_name=field[1];if(field_type_name=="collection"){throw"not supported here. should use code in enhanced-data-object.";console.log("pre make coll");var coll=new jsgui.Collection({context:this._context});console.log("pre set coll parent");coll.parent(this);this._[field_name]=coll;return this._[field_name]}else if(field_type_name=="data_object"){var dobj=new jsgui.Data_Object({context:this._context});dobj.parent(this);this._[field_name]=dobj;return this._[field_name]}else{var dtoc=jsgui.ensure_data_type_data_object_constructor(field_type_name);var obj=new dtoc({context:this._context});obj.parent(this);this._[field_name]=obj;return this._[field_name]}}else if(sig_field=="[s,[s,s]]"){var field_name=field[0];var field_info=field[1];if(field_info[0]=="collection"){var collection_type_name=field_info[1]}}else if(sig_field=="[s,[s,o]]"){var field_name=field[0];var field_info=field[1];var data_type_name=field_info[0];if(data_type_name=="collection"){var objDef=field_info[1];throw"not supported here. should use code in enhanced-data-object."}}}else{return this._[field_name]}}else{var res=ll_get(this._,a[0]);return res}}else if(a.l==0){return this._}}}),___get_fields_chain:function(){var my_fields=this._fields;console.log("my_fields "+stringify(my_fields));var con=this.constructor;console.log("con "+stringify(con))},_get_input_processors:function(){return jsgui.input_processors},set:fp(function(a,sig){if(this._abstract)return false;var that=this,res;var input_processors;if(this._module_jsgui){input_processors=this._module_jsgui.input_processors}else{input_processors=this._get_input_processors()}if(is_defined(this._data_type_name)&&input_processors[this._data_type_name]){throw"stop";console.log("is_defined _data_type_name and input_processors[this._data_type_name]");var raw_input=a;var parsed_input_obj=input_processors[this._data_type_name](raw_input);this._=parsed_input_obj;this.trigger("change")}else{if(a.l==2||a.l==3){var property_name=a[0],value=a[1];var ta2=tof(a[2]);var silent=false;var source;if(ta2=="string"||ta2=="boolean"){silent=a[2]}if(ta2=="control"){source=a[2]}if(!this._initializing&&this._map_read_only&&this._map_read_only[property_name]){throw'Property "'+property_name+'" is read-only.'}else{var split_pn=property_name.split(".");if(split_pn.length>1&&property_name!="."){var spn_first=split_pn[0];var spn_arr_next=split_pn.slice(1);var data_object_next=this.get(spn_first);if(data_object_next){var res=data_object_next.set(spn_arr_next.join("."),value);if(!silent){var e_change={name:property_name,value:value};if(source){e_change.source=source}this.raise_event("change",e_change)}return res}else{var stack=(new Error).stack;console.log(stack);throw"No data object at this level."}throw"10)stop"}else{var data_object_next=this.get(property_name);if(!is_defined(data_object_next)){var tv=typeof value;var dv;if(tv=="string"||tv=="number"||tv=="boolean"||tv=="date"){dv=new Data_Value({value:value})}else{dv=value}this._[property_name]=dv;if(!silent){var e_change={name:property_name,value:dv};if(source){e_change.source=source}this.raise_event("change",e_change)}return value}else{if(is_js_native(data_object_next)){this._[property_name]=value;res=value}else{this._[property_name]=value;res=value}if(!silent){var e_change={name:property_name,value:value};if(source){e_change.source=source}this.trigger("change",e_change)}return res}}}}else{if(sig=="[D]"){this._[property_name]=value}if(sig=="[o]"){var that=this;var res={};each(a[0],function(i,v){res[i]=that.set(i,v)});return res}if(sig=="[c]"){this._[property_name]=value}}}}),has:function(property_name){return is_defined(this.get(property_name))}});var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;var get_fields_chain=function(data_object_class){var res=[];var inner=function(data_object_class){var fields=data_object_class._fields;if(fields){res.push(fields)}var sc=data_object_class._superclass;if(sc){inner(sc)}};inner(data_object_class);return res};var get_chained_fields=function(data_object_class){var fc=get_fields_chain(data_object_class);var i=fc.length;var res=[];while(i--){var item=fc[i];var c=0;each(item,function(i2,field_info){if(tof(i2)=="string"){c=c+1;res.push([c,[i2,field_info]])}else{res.push([i2,field_info]);c=i2}})}return res};var chained_fields_to_fields_list=function(chained_fields){var l=chained_fields.length;var res=new Array(l);for(var c=0;c<l;c++){res[c]=chained_fields[c][1]}return res};jsgui.map_classes={};Data_Object.extend=function(prop,post_init){var _super=this.prototype;initializing=true;var prototype=new this;var for_class={};initializing=false;if(typeof prop==="string"){var data_type_name=prop;var dtis=jsgui.data_types_info;var data_type_info=dtis[data_type_name];for_class[data_type_name]=data_type_name;for_class[data_type_info]=data_type_info;prototype["__type_name"]=data_type_name;prototype["__data_type_info"]=data_type_info;prop={}}var prop_item,t_prop_item,tmp,name,res;for(name in prop){prop_item=prop[name];if(name.charAt(0)==="#"){prototype[name.substring(1)]=prototype[prop_item]}else{t_prop_item=typeof prop_item;if(t_prop_item==="function"){prototype[name]=typeof _super[name]==="function"&&fnTest.test(prop_item)?function(name,fn){return function(){tmp=this._super;this._super=_super[name];res=fn.apply(this,arguments);this._super=tmp;return res}}(name,prop[name]):prop[name]}else if(t_prop_item==="object"||t_prop_item==="boolean"){if(name=="class_name"){for_class["_class_name"]=prop_item}else if(name=="fields"){for_class["_fields"]=prop_item}else if(name=="connect_fields"){for_class["_connect_fields"]=prop_item}else{prototype[name]=prop[name]}}else{prototype[name]=prop[name]}}}var Class=function(){if(!initializing){if(this.init){this.init.apply(this,arguments);if(this.post_init){this.post_init.apply(this,arguments)}if(post_init){post_init.call(this)}}else{var spec=arguments[0]||{};spec.abstract=true;return new Class(spec)}}};Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;for(i in for_class){Class[i]=for_class[i]}if(Class["class_name"]){jsgui.map_classes[Class["class_name"]]=Class}Class._superclass=this;return Class};var data_object_matches_field_constraints=function(data_object,field_constraints){each(field_constraints,function(fc_name,fc_value){})};var Enhanced_Data_Object=null;var set_Enhanced_Data_Object=function(EDO){Enhanced_Data_Object=EDO};Data_Object.map_data_type_data_object_constructors=jsgui.map_data_type_data_object_constructors;Data_Object.Mini_Context=Mini_Context;Data_Object.set_Enhanced_Data_Object=set_Enhanced_Data_Object;var dobj=function(obj,data_def){var cstr=Data_Object;if(Enhanced_Data_Object)cstr=Enhanced_Data_Object;var res;if(data_def){res=new cstr({data_def:data_def})}else{res=new cstr({})}var tobj=tof(obj);if(tobj=="object"){var res_set=res.set;each(obj,function(i,v){res_set.call(res,i,v)})}return res};var parse_field_text=Fields_Collection.parse_field_text;var parse_data_type=Fields_Collection.parse_data_type;jsgui.map_data_type_data_object_constructors=jsgui.map_data_type_data_object_constructors||{};jsgui.map_data_type_data_object_constructors["boolean"]=Data_Value;var ensure_data_type_data_object_constructor=function(data_type_name){if(!jsgui.map_data_type_data_object_constructors[data_type_name]){var dto=jsgui.data_types_info[data_type_name];console.log("dto "+stringify(dto));var dtc=Data_Object.extend({fields:dto});jsgui.map_data_type_data_object_constructors[data_type_name]=dtc}return jsgui.map_data_type_data_object_constructors[data_type_name]};jsgui.ensure_data_type_data_object_constructor=ensure_data_type_data_object_constructor;input_processors.field_text=parse_field_text;input_processors.data_type=parse_data_type;var Collection_Index=Class.extend({init:function(spec){if(is_defined(spec.fields)){this.fields=spec.fields;if(tof(spec.fields)=="array"){this.alphabetic_fields=clone(spec.fields).sort()}}this.__type="collection_index"},add_object:function(obj){var tobj=tof(obj);if(tobj=="array"){var that=this;each(obj,function(i,v){that.add_object(v)})}else if(tobj=="data_object"){this.unsafe_add_object(obj)}}});var BPD_Collection_Index=Collection_Index.extend({init:function(spec){}});var index_key_separator=",";var Ordered_Collection_Index=Collection_Index.extend({init:function(spec){this._super(spec);this.index_type="ordered"}});var get_fields_key=function(fields){var tf=tof(fields);if(tf=="array"){return fields.join(index_key_separator)}else if(tf=="string"){return fields}};var get_obj_fields_key=function(obj,fields){var tFields=tof(fields);if(tFields=="string"){fields=[fields]}var arr_res=[];each(fields,function(i,field_name){var tFieldName=tof(field_name);if(tFieldName=="array"){arr_res.push(stringify(field_name))}else if(tFieldName=="string"){var field_val=obj.get(field_name);arr_res.push(field_val)}else if(tFieldName=="object"){if(field_name.attached){var attachedObjName;var attachedObjFieldName;var c=0;each(field_name.attached,function(i,v){attachedObjName=i;attachedObjFieldName=v;c++});if(c!=1){throw"unexpected number of items in attached definition"}else{var attachedObj=obj[attachedObjName];var res=attachedObj.get(attachedObjFieldName);arr_res.push(res)}}}});return arr_res.join(index_key_separator)};var Sorted_Collection_Index=Collection_Index.extend({init:function(spec){this._super(spec);this.index_type="sorted";this.sorted_kvs=new Sorted_KVS(12)},each:function(callback){return this.sorted_kvs.each(callback)},unsafe_add_object:function(obj){var fields_key=get_obj_fields_key(obj,this.fields);this.sorted_kvs.put(fields_key,obj)},get:fp(function(a,sig){if(sig=="[s]"){var search_term=a[0];var kvps=this.sorted_kvs.get(search_term);return kvps}if(tof(a[0])=="array"){var search_term=a[0].join(",");var kvps=this.sorted_kvs.get(search_term);return kvps}}),has:fp(function(a,sig){if(sig=="[s]"){return this.sorted_kvs.key_count()>0}}),remove:function(obj){var fields_key;if(tof(obj)=="string"){fields_key=obj}else{fields_key=get_obj_fields_key(obj,this.fields)}this.sorted_kvs.out(fields_key)}});var Dict_Collection_Index=Collection_Index.extend({init:function(spec){this._super(spec);this.index_type="dict";this.dict={};this.unique_mode=true},can_add_object:function(obj){var fields_key=get_obj_fields_key(obj,this.fields);var existing_obj=this.dict[fields_key];if(is_defined(existing_obj)){if(this.unique_mode===true){return false}}return true},unsafe_add_object:function(obj){var fields_key=get_obj_fields_key(obj,this.fields);this.dict[fields_key]=obj},get:fp(function(a,sig){if(a.l==1&&tof(a[0])=="string"){return this.dict[a[0]]}})});var Collection_Index_System=Class.extend({init:function(spec){this.collection=spec.collection;this.index_map={}},notify_insertion:function(pos){return false},clear:function(){this.index_map={}},search_for_index_with_fields:fp(function(a,sig){if(sig=="[s]"){return this.search_for_index_with_fields([a[0]])}if(sig=="[a]"){var idx=this.get_index_starting(a[0]);return idx}if(sig=="[o]"){var res;var matching_count=0;this.iterate_indexes(function(index,stop){var i_fields=index.fields;if(tof(i_fields)=="string")i_fields=[i_fields];var ae=are_equal([a[0]],i_fields);if(ae){res=index;matching_count++}});if(matching_count>1){throw"unexpected matching_count > 1"}else{if(matching_count==1){return res}}}}),find:fp(function(a,sig){if(sig=="[o]"){var objQuery=a[0];var indexes=this.indexes();var map_single_field_indexes_by_field={};each(indexes,function(i,v){if(v.fields.length==1){var field=v.fields[0];var tField=tof(field);if(tField=="string"){map_single_field_indexes_by_field[field]=v}}});var c=0;var keys=[];each(objQuery,function(key,value){c++;keys.push(key)});if(keys.length==1){var index=map_single_field_indexes_by_field[keys[0]];if(index){var res=index.get(objQuery[keys[0]]);return res}else{return false}}throw"stop";return false}if(sig=="[a]"){var indexes=[];this.iterate_indexes(function(finding_index){indexes.push(finding_index)});var search_fields=[];var search_values=[];each(a[0],function(i,v){search_fields.push(v[0]);search_values.push(v[1])});var equal_indices=[];each(indexes,function(i,idx){var idx_fields=idx.fields;if(idx_fields.length>=search_fields.length){var idx_fields_to_check;if(tof(idx_fields)=="array"){idx_fields_to_check=idx_fields.slice(0,search_fields.length)}else{idx_fields_to_check=[idx_fields]}if(are_equal(idx_fields_to_check,search_fields)){equal_indices.push(idx)}}});if(equal_indices.length>0){var idx=equal_indices[0];var res_indices_get=equal_indices[0].get(search_values);return res_indices_get}}if(sig=="[o,s]"){var fieldDef=a[0];var index=this.search_for_index_with_fields(fieldDef);if(index){var res=index.get(a[1])}return res}if(a.l==2&&tof(a[0])=="array"){var index=this.search_for_index_with_fields([a[0]]);if(index){var res=index.get(a[1])}return res}if(a.l==2&&tof(a[0])=="string"){var index=this.search_for_index_with_fields(a[0]);if(index){var res=index.get(a[1])}return res}}),get_index_starting:function(fields){if(tof(fields)=="string"){fields=[fields]}var matching_indexes=[];this.iterate_indexes(function(index,stop){var i_fields=index.fields;if(tof(i_fields)=="string")i_fields=[i_fields];var ae=are_equal(fields,i_fields);if(ae){matching_indexes.push(index)}});if(matching_indexes.length>1){throw"get_index_starting, more than 1 matching index found. Needs implementation"}else{return matching_indexes[0]}},ensure_index:fp(function(a,sig){if(a.l==1&&is_arr_of_strs(a[0])){var new_index_spec=a[0];var sci=new Sorted_Collection_Index({fields:new_index_spec});sci.add_object(this.collection._arr);var fields_key=get_fields_key(new_index_spec);this.index_map[fields_key]=this.index_map[fields_key]||{};this.index_map[fields_key]["indexes_by_type"]=this.index_map[fields_key]["indexes_by_type"]||{};this.index_map[fields_key]["indexes_by_type"]["sorted"]=sci;return sci}if(a.l==2){if(tof(a[1])=="string"){var index_type=a[1];if(tof(a[0])=="array"){var fields=a[0];return this.ensure_index[a[0]]}if(tof(a[0])=="string"){var field_name=a[0];var e_idx=this.get_index_by_type_by_fields([field_name],index_type);if(!is_defined(e_idx)){var idx=new Dict_Collection_Index({fields:[field_name]});this.index_map[field_name]=this.index_map[field_name]||{};this.index_map[field_name]["indexes_by_type"]=this.index_map[field_name]["indexes_by_type"]||{};this.index_map[field_name]["indexes_by_type"][index_type]=idx;idx.add_object(this.collection._arr)}}}}}),set_index_by_type_by_fields:function(index,arr_fields,index_type){var c=0,l=arr_fields.length;var i=this;while(c<l){var field=arr_fields[c];var tField=tof(field);if(tField=="string"){if(!i.index_map[field]){i.index_map[field]={}}i=i.index_map[field]}else{if(tField=="object"){var fieldStr=stringify(field);if(!i.index_map[fieldStr]){i.index_map[fieldStr]={}}i=i.index_map[fieldStr]}if(tField=="array"){var fieldStr=stringify(field);if(!i.index_map[fieldStr]){i.index_map[fieldStr]={}}i=i.index_map[fieldStr]}}c++}i["indexes_by_type"]=i["indexes_by_type"]||{};i["indexes_by_type"][index_type]=index},set_index:function(index){this.set_index_by_type_by_fields(index,index.fields,index.index_type)},get_index_by_type_by_fields:function(arr_fields,index_type){var c=0,l=arr_fields.length;var i=this;while(c<l){i=i.index_map[arr_fields[c]];c++}if(i){var index=i["indexes_by_type"][index_type]}return index},indexes:fp(function(a,sig){if(a.l==0){var res=[];this.iterate_indexes(function(index){res.push(index)});return res}else{throw"Setting indexes not supported here (yet)"}}),iterate_indexes:function(index_callback){var iterate_level=function(level){each(level,function(i,v,stop1){var ibt=v["indexes_by_type"];if(ibt){each(ibt,function(i2,v2,stop2){var full_stop=function(){stop2();stop1()};index_callback(v2,full_stop)})}})};iterate_level(this.index_map)},_____can_add_object:function(obj){var tobj=tof(obj);if(tobj=="data_object"){var can_add=true;this.iterate_indexes(function(index){var index_can_add=index.can_add_object(obj);if(!index_can_add){can_add=false}});return can_add}else{return false}},add_object:function(obj){return this.unsafe_add_object(obj)},unsafe_add_object:function(obj){this.iterate_indexes(function(index){index.unsafe_add_object(obj)})},remove:function(obj){this.iterate_indexes(function(index){index.remove(obj)})},accepts:fp(function(a,sig){if(sig=="[D]"){this._accepts=a[0]}if(sig=="[o]"){throw"Map object as acceptance criteria not yet supported in Collection"}})});var Collection_Index={System:Collection_Index_System,Sorted:Sorted_Collection_Index};var dop=Data_Object.prototype;var old_set_field=dop.set_field;var new_set_field=fp(function(a,sig){if(sig=="[s,[f]]"){var field_name=a[0];var dt_constructor=a[1][0];var coll=new Collection(dt_constructor);coll._data_type_constraint=new Constraint.Collection_Data_Type(dt_constructor);this.set(field_name,coll)}else{old_set_field.apply(this,a)}});dop.set_field=new_set_field;var obj_matches_query_obj=function(obj,query){var matches=true;each(query,function(fieldName,fieldDef){var tfd=tof(fieldDef);if(tfd=="string"||tfd=="boolean"||tfd=="number"){matches=matches&&obj[fieldName]===fieldDef}else{throw"need more work on more complex queries for collection find, iterative search"}});return matches};var Collection=Data_Object.extend({init:function(spec,arr_values){this.__type="collection";if(spec.abstract===true){var tspec=tof(spec);if(tspec==="function"){this.constraint(spec)}}else{this._relationships=this._relationships||{};this._arr_idx=0;this._arr=[];this.index_system=new Collection_Index_System({collection:this});var spec=spec||{};if(tof(spec)=="array"){spec={load_array:spec}}else{if(tof(spec)=="function"){if(spec.abstract===true){this._abstract=true}else{if(is_constructor_fn(spec)){var chained_fields=Data_Object.get_chained_fields(spec);var chained_fields_list=Data_Object.chained_fields_to_fields_list(chained_fields);var index_field_names=[],field_name,field_text;each(chained_fields_list,function(i,v){field_name=v[0];field_text=v[1];var isIndexed=field_text.indexOf("indexed")>-1;var isUnique=field_text.indexOf("unique")>-1;if(isIndexed||isUnique){index_field_names.push([field_name])}});var old_spec=spec;spec={constraint:spec};if(old_spec==String){spec.index_by="value"}if(index_field_names.length>0){spec.index_by=index_field_names}}}}else if(tof(spec)=="string"){var map_native_constructors={array:Array,"boolean":Boolean,number:Number,string:String,object:Object};var nc=map_native_constructors[spec];if(nc){spec={constraint:nc};if(nc==String){spec.index_by="value"}}}}if(is_defined(spec.items)){spec.load_array=spec.load_array||spec.items}if(arr_values){console.log("load arr_values ------------");spec.load_array=arr_values}if(is_defined(spec.accepts)){this._accepts=spec.accepts}if(jsgui.__data_id_method=="init"){if(this._context){this.__id=this._context.new_id(this.__type_name||this.__type);this._context.map_objects[this.__id]=this}else{}}if(!this.__type){}}this._super(spec)},set:function(value){var tval=tof(value);var that=this;if(tval=="data_object"){this.clear();return this.push(value)}else if(tval=="array"){this.clear();each(value,function(i,v){that.push(v)})}else{if(tval=="collection"){throw"stop";this.clear();value.each(function(i,v){that.push(v)})}else{return this._super(value)}}},clear:function(){this._arr_idx=0;this._arr=[];this.index_system=new Collection_Index_System({collection:this});this.trigger("change",{type:"clear"})},stringify:function(){var res=[];if(this._abstract){var ncto=native_constructor_tof(this._type_constructor);res.push("~Collection(");if(ncto){res.push(ncto)}else{}res.push(")")}else{res.push("Collection(");var first=true;this.each(function(i,v){if(!first){res.push(", ")}else{first=false}res.push(stringify(v))});res.push(")")}return res.join("")},toString:function(){return stringify(this._arr)},toObject:function(){var res=[];this.each(function(i,v){res.push(v.toObject())});return res},each:fp(function(a,sig){if(sig=="[f]"){return each(this._arr,a[0])}else{if(sig=="[X,f]"){var index=a[0];var callback=a[1];return index.each(callback)}else{if(a.l==2){return each(this._arr,a[0],a[1])}}}}),eac:fp(function(a,sig){if(sig=="[f]"){return eac(this._arr,a[0])}else{if(sig=="[X,f]"){var index=a[0];var callback=a[1];return index.eac(callback)}else{if(a.l==2){return eac(this._arr,a[0],a[1])}}}}),_id:function(){if(this._context){this.__id=this._context.new_id(this.__type_name||this.__type)}else{if(!is_defined(this.__id)){}}return this.__id},length:function(){return this._arr.length},find:fp(function(a,sig){if(a.l==1){var index_system_find_res=this.index_system.find(a[0]);if(index_system_find_res===false){var foundItems=[];each(this,function(index,item){throw"stop"})}else{return index_system_find_res}}if(sig=="[o,s]"){return this.index_system.find(a[0],a[1])}if(sig=="[s,s]"){return this.index_system.find(a[0],a[1])}if(sig=="[a,s]"){return this.index_system.find(a[0],a[1])}if(sig=="[s,o]"){var propertyName=a[0];var query=a[1];var foundItems=[];each(this,function(index,item){var itemProperty=item.get(propertyName);var tip=tof(itemProperty);if(tip=="array"){each(itemProperty,function(i,v){var matches=obj_matches_query_obj(v,query);if(matches){foundItems.push(v)}})}});return new Collection(foundItems)}}),get:fp(function(a,sig,_super){if(sig=="[n]"||sig=="[i]"){return this._arr[a[0]]}if(sig=="[s]"){return Data_Object.prototype.get.apply(this,a)}}),insert:function(item,pos){this._arr.splice(pos,0,item);this.index_system.notify_insertion(pos);this.trigger("change",{name:"insert",item:item,pos:pos})},remove:fp(function(a,sig){var that=this;if(sig=="[n]"){var own_id=this._id();var pos=a[0];var item=this._arr[pos];var o_item=item;var spliced_pos=pos;this._arr.splice(pos,1);this._arr_idx--;var length=this._arr.length;while(pos<length){var item=this._arr[pos];item.relationships[own_id]=[that,pos];pos++}this.index_system.remove(o_item);var e={target:this,item:item,position:spliced_pos};this.raise_event(that,"remove",e)}if(sig=="[s]"){var key=a[0];var obj=this.index_system.find([["value",key]]);var my_id=this.__id;var item_pos_within_this=obj[0]._relationships[my_id];this.index_system.remove(key);this._arr.splice(item_pos_within_this,1);for(var c=item_pos_within_this,l=this._arr.length;c<l;c++){var item=this._arr[c];item._relationships[my_id]--}var e={target:this,item:obj[0],position:item_pos_within_this};this.raise_event(that,"remove",e)}}),has:function(obj_key){if(this._data_type_constraint){if(this._data_type_constraint.data_type_constructor){if(this._data_type_constraint.data_type_constructor===String){var found=this.index_system.find("value",obj_key);return found.length>0}}}},get_index:fp(function(a,sig){if(sig=="[s]"){return this.index_system.search(a[0])}}),find_unique_constraint:function(field){var item=null;if(tof(field)=="array"){}else if(tof(field)=="string"){each(this._unique_constraints,function(i,v,stop){if(v.fields===field){item=v;stop()}})}return item},fields:fp(function(a,sig){var that=this;if(sig=="[o]"){each(a[0],function(i,v){that.set_field(i,v)});that.constraint(a[0])}else{if(!this._data_object_constraint){this._data_object_constraint=Constraint.from_obj(new Data_Object)}var doc=this._data_object_constraint;if(a.l==0){return doc.data_object.fc.get()}if(a.l==1&&tof(a[0]=="array")){return doc.data_object.fc.set(a[0])}}}),set_field:fp(function(a,sig){var that=this;var doc=that._data_object_constraint=that._data_object_constraint||Constraint.from_obj(new Data_Object);if(a.l==2&&tof(a[0])=="string"){doc.data_object.fc=doc.data_object.fc||new Data_Object_Field_Collection;return doc.data_object.fc.set(a[0],a[1])}}),remove_field:fp(function(a,sig){var doc=this._data_object_constraint;if(doc){if(sig=="[s]"){return doc.data_object.fc.out(a[0])}}}),get_data_type_constraint:function(){return this._data_type_constraint},constraint:fp(function(a,sig){if(sig=="[]"){var res=null;if(this._data_type_constraint){res={data_type:this._data_type_constraint}}if(this._data_object_constraint){res=res||{};res.data_object=this._data_object_constraint}if(this._data_def_constraint){res=res||{};res.data_def=this._data_def_constraint}return res}if(sig=="[o]"){this._data_def_constraint=new Constraint.Collection_Data_Def(a[0])}if(sig=="[f]"){if(a[0]===Number){this._data_type_constraint=new Constraint.Collection_Data_Type(a[0]);return this._data_type_constraint}if(a[0]===String){this._data_type_constraint=new Constraint.Collection_Data_Type(a[0]);return this._data_type_constraint}else if(is_constructor_fn(a[0])){var data_type_constructor=a[0];var dtc=this._data_type_constraint;if(dtc){var cdtc=this._data_type_constraint.data_type_constructor;if(cdtc&&cdtc===data_type_constructor){return dtc}}this._data_type_constraint=new Constraint.Collection_Data_Type(data_type_constructor);return this._data_type_constraint}}if(sig=="[D]"){var constraint=constraint_from_obj(a[0]);this._data_object_constraint=constraint}if(sig=="[[s,s]]"){var constraint_def=a[0];var constraint=constraint_from_obj(constraint_def);var c_type=constraint._constraint_type;if(c_type=="unique"){this._unique_constraints=this._unique_constraints||[];var field_name=constraint_def[1];var existing_unique_constraint=this.find_unique_constraint(field_name);if(existing_unique_constraint){return existing_unique_constraint}else{}}}}),get_unique_constraint:function(fields){if(tof(fields)=="string")fields=[fields];each(this._unique_constraints,function(i,unique_constraint){var uc_fields=unique_constraint.fields;if(are_equal(uc_fields,fields))return unique_constraint})},unique:fp(function(a,sig){var that=this;if(sig=="[s]"){return this.unique([a[0]])}if(tof(a[0])=="array"){if(is_arr_of_arrs(a[0])){}if(is_arr_of_strs(a[0])){var existing_uc=this.get_unique_constraint(a[0]);if(existing_uc)return existing_uc;var new_uc=new Constraint.Unique({fields:a[0]});this._unique_constraints=this._unique_constraints||[];this._unique_constraints.push(new_uc);var idx=this.index(a[0])}}}),indexes:fp(function(a,sig){if(a.l==0){var index_system=this.index_system;var indexes=index_system.indexes();return indexes
}}),index_by:fp(function(a,sig){var that=this;if(sig=="[a]"){if(is_arr_of_strs(a[0])){var relevant_index=this.index_system.get_index_starting(a[0]);if(relevant_index){return relevant_index}else{var index_spec=a[0];var new_index=this.index_system.ensure_index(index_spec);return new_index}}if(is_arr_of_arrs(a[0])){each(a[0],function(i,specified_index){that.index(specified_index)})}}var that=this;if(sig=="[s]"){return that.index({sorted:[[a[0]]]})}if(sig=="[o]"){var index_map=a[0];each(index_map,function(index_type,index_definition){if(index_type=="sorted"){if(tof(index_definition)=="array"){if(is_arr_of_arrs(index_definition)){var indexes=[];each(index_definition,function(i,individual_index_fields){var index=new Sorted_Collection_Index({fields:individual_index_fields});that.index_system.set_index(index);indexes.push(index)});that.index_system._primary_unique_index=indexes[0];return indexes[0]}if(is_arr_of_strs(index_definition)){}}}})}}),index:fp(function(a,sig){if(a.l==1){return this.index_by(a[0])}}),test_object_against_constraints:function(obj){if(this._type_constructor){if(!obj instanceof this._type_constructor)return false}if(this._data_object_constraint){if(!this._data_object_constraint.match(obj))return false}if(this._data_type_constraint){if(!this._data_type_constraint.match(obj))return false}var that=this;var res=true;each(this._unique_constraints,function(i,unique_constraint){var uc_fields=unique_constraint.fields;var find_params=[];each(uc_fields,function(i,field_name){var field_value=obj.get(field_name);find_params.push([field_name,field_value])});var found=that.find(find_params);if(found&&found.length>0){res=false}});return res},push:function(value){var tv=tof(value);if(tv=="object"){var dtc=this._data_type_constraint;if(dtc){var dtcon=dtc.data_type_constructor;value=new dtcon(value)}else{var ddc=this._data_def_constraint;var match=true;if(ddc)match=ddc.match(value);if(!match){throw"Does not match data_def constraint"}else{if(ddc){value=dobj(value,ddc.data_def)}else{value=dobj(value)}value.constraints(ddc)}}tv=tof(value)}if(tv=="collection"){var constraints_test_res=this.test_object_against_constraints(value);if(constraints_test_res){this.index_system.unsafe_add_object(value);var pos=this._arr.length;this._arr.push(value);value.parent(this,pos);var e={target:this,item:value,position:pos,type:"insert"};this.raise_event("change",e);this._arr_idx++}else{var stack=(new Error).stack;throw"Collection constraint(s) not satisfied"}}if(tv=="data_object"||tv=="control"){var constraints_test_res=this.test_object_against_constraints(value);if(constraints_test_res){this.index_system.unsafe_add_object(value);var pos=this._arr.length;this._arr.push(value);var e={target:this,item:value,position:pos,type:"insert"};value.parent(this,pos);this.raise_event("change",e);this._arr_idx++}else{var stack=(new Error).stack;throw"Collection constraint(s) not satisfied"}}if(tv=="array"){return this.push(new Collection(value))}if(tv=="string"||tv=="number"){var constraints_test_res=this.test_object_against_constraints(value);if(constraints_test_res){var dv=new Data_Value({value:value});var pos=this._arr.length;this._arr.push(dv);var e={target:this,item:dv,position:pos,type:"insert"};this.raise_event("change",e);if(tv=="string"){this.index_system.unsafe_add_object(dv)}}else{console.trace();throw"wrong data type"}}this._arr_idx++;return value},add:function(value){return this.push(value)},load_array:function(arr){var that=this;var dtc=this._data_type_constraint;if(dtc){var data_type_constructor=dtc.data_type_constructor;for(var c=0,l=arr.length;c<l;c++){that.push(arr[c])}}else{for(var c=0,l=arr.length;c<l;c++){that.push(arr[c])}}this.raise_event("load")},values:fp(function(a,sig){if(a.l==0){return this._arr}else{var stack=(new Error).stack;throw"not yet implemented"}}),value:function(){var res=[];this.each(function(i,v){if(typeof v.value=="function"){res.push(v.value())}else{res.push(v)}});return res}});Collection.extend=function(){var a=arguments;var args=[a[0]];if(a[0].data_object){args.push(function(){this.constraint(a[0].data_object)})}var res=Data_Object.extend.apply(this,args);return res};var vectorify=function(n_fn){var fn_res=fp(function(a,sig){if(a.l>2){var res=a[0];for(var c=1,l=a.l;c<l;c++){res=fn_res(res,a[c])}return res}else{if(sig=="[n,n]"){return n_fn(a[0],a[1])}else{var ats=atof(a);if(ats[0]=="array"){if(ats[1]=="number"){var res=[],n=a[1];each(a[0],function(i,v){res.push(fn_res(v,n))});return res}if(ats[1]=="array"){if(ats[0].length!=ats[1].length){throw"vector array lengths mismatch"}else{var res=[],arr2=a[1];each(a[0],function(i,v){res.push(fn_res(v,arr2[i]))});return res}}}}}});return fn_res};var n_add=function(n1,n2){return n1+n2},n_subtract=function(n1,n2){return n1-n2},n_multiply=function(n1,n2){return n1*n2},n_divide=function(n1,n2){return n1/n2};var v_add=vectorify(n_add),v_subtract=vectorify(n_subtract);var v_multiply=vectorify(n_multiply),v_divide=vectorify(n_divide);var vector_magnitude=function(vector){var res=Math.sqrt(Math.pow(vector[0],2)+Math.pow(vector[1],2));return res};var distance_between_points=function(points){var offset=v_subtract(points[1],points[0]);console.log("offset "+stringify(offset));return vector_magnitude(offset)};var remove_sig_from_arr_shell=function(sig){if(sig[0]=="["&&sig[sig.length-1]=="]"){return sig.substring(1,sig.length-1)}return sig};var execute_on_each_simple=function(items,fn){var res=[],that=this;each(items,function(i,v){res.push(fn.call(that,v))});return res};var filter_map_by_regex=function(map,regex){var res={};each(map,function(i,v){if(i.match(regex)){res[i]=v}});return res};var npx=arrayify(function(value){var res,a=arguments,t=tof(a[0]);if(t=="string"){res=a[0]}else if(t=="number"){res=a[0]+"px"}return res});var no_px=arrayify(fp(function(a,sig){var re=/px$/,res;if(sig=="[s]"&&re.test(a[0])){res=parseInt(a[0])}else{res=a[0]}return res}));var arr_ltrb=["left","top","right","bottom"];var str_arr_mapify=function(fn){var res=fp(function(a,sig){if(a.l==1){if(sig=="[s]"){var s_pn=a[0].split(" ");if(s_pn.length>1){return res.call(this,s_pn)}else{return fn.call(this,a[0])}}if(tof(a[0])=="array"){var res2={},that=this;each(a[0],function(i,v){res2[v]=fn.call(that,v)});return res2}}});return res};var arr_hex_chars=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var dict_hex_to_bin={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15};var str_hex_to_int=function(str_hex){str_hex=str_hex.toUpperCase();var i=str_hex.length;var res=0,exp=1;while(i--){var i_part=dict_hex_to_bin[str_hex.charAt(i)];var ip2=i_part*exp;res=res+ip2;exp=exp*16}return res};var byte_int_to_str_hex_2=function(byte_int){var a=Math.floor(byte_int/16),b=byte_int%16,sa=arr_hex_chars[a],sb=arr_hex_chars[b],res=sa+sb;return res};var arr_rgb_to_str_hex_6=function(arr_rgb){var r=byte_int_to_str_hex_2(arr_rgb[0]);var res=r+byte_int_to_str_hex_2(arr_rgb[1])+byte_int_to_str_hex_2(arr_rgb[2]);return res};var arr_rgb_to_css_hex_6=function(arr_rgb){return"#"+arr_rgb_to_str_hex_6(arr_rgb)};var input_processors={};var output_processors={};var validators={number:function(value){return tof(value)=="number"}};var referred_object_is_defined=function(object_reference){return is_defined(object_reference[0][object_reference[1]])};var set_vals=function(obj,map){each(map,function(i,v){obj[i]=v})};var _data_generators={};var truth=function(value){return value===true};var extend=jsgui.extend,fp=jsgui.fp,stringify=jsgui.stringify,tof=jsgui.tof;extend(jsgui.data_types_info,{color:["indexed_array",[["red","number"],["green","number"],["blue","number"]]],oltrb:["optional_array",["left","top","right","bottom"]]});var create_input_function_from_data_type_info=function(data_type_info){console.log("create_input_function_from_data_type_info data_type_info "+stringify(data_type_info));if(tof(data_type_info)=="array"){var secondary_instruction=data_type_info[0];var arr_items=data_type_info[1];if(tof(arr_items)=="string"){if(jsgui.data_types_info[secondary_instruction]){if(jsgui.data_types_info[arr_items]){}}}if(tof(arr_items)=="array"){if(secondary_instruction=="indexed_array"){var res=fp(function(a,sig){if(sig=="[[[n,n,n]]]"){res=a[0][0];return res}if(!data_type_info.map_pos){data_type_info.map_pos={};each(arr_items,function(i,v){console.log("i "+i);console.log("v "+v);data_type_info.map_pos[v[0]]=i})}if(sig=="[[o]]"){var dtimp=data_type_info.map_pos;var o=a[0][0];var res=[];each(o,function(i,v){var pos=dtimp[i];console.log("pos "+pos);console.log("v "+v);res[pos]=v});return res}});return res}}}};var color_preprocessor_parser=fp(function(a,sig){console.log("color_preprocessor_parser a "+stringify(a));console.log("color_preprocessor_parser sig "+sig);if(sig=="[s]"){var input=a[0];var rx_hex=/(#([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2}))/;var m=input.match(rx_hex);if(m){var r=jsgui.str_hex_to_int(m[2]);var g=jsgui.str_hex_to_int(m[3]);var b=jsgui.str_hex_to_int(m[4]);var res=[r,g,b];return res}}});var color_preprocessor=function(fn_color_processor){var that=this;var res=fp(function(a,sig){if(sig=="[[s]]"){var rx_hex=/(#([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2}))/;var input=a[0][0];var m=input.match(rx_hex);if(m){var r=jsgui.str_hex_to_int(m[2]);var g=jsgui.str_hex_to_int(m[3]);var b=jsgui.str_hex_to_int(m[4]);var res=[r,g,b];return res}}else{return fn_color_processor.apply(that,a)}});return res};jsgui.input_processors["optional_array"]=fp(function(a,sig){if(a.l==2){var oa_params=a[0],input=a[1];if(tof(input)=="array"){if(input.length<=oa_params.length){return input}}else{return input}}if(a.l==3){var oa_params=a[0],items_data_type_name=a[1],input=a[2];var input_processor_for_items=jsgui.input_processors[items_data_type_name];if(tof(input)=="array"){if(input.length<=oa_params.length){var res=[];each(input,function(i,v){res.push(input_processor_for_items(v))});return res}}else{return input_processor_for_items(input)}}});jsgui.input_processors["indexed_array"]=fp(function(a,sig){if(a.l==2){var ia_params=a[0],input=a[1];if(tof(input)=="array"){if(input.length<=ia_params.length){return input}}}if(a.l==3){var ia_params=a[0],items_data_type_name=a[1],input=a[2];var input_processor_for_items=jsgui.input_processors[items_data_type_name];if(tof(input)=="array"){if(input.length<=ia_params.length){var res=[];each(input,function(i,v){res.push(input_processor_for_items(v))});return res}}}});jsgui.input_processors["n_units"]=function(str_units,input){if(tof(input)=="number"){return[input,str_units]}if(tof(input)=="string"){var rx_n_units=/^(\d+)(\w+)$/;var match=input.match(rx_n_units);if(match){return[parseInt(match[1]),match[2]]}rx_n_units=/^(\d*\.\d+)(\w+)$/;match=input.match(rx_n_units);if(match){return[parseFloat(match[1]),match[2]]}}};jsgui.map_data_type_data_object_constructors=jsgui.map_data_type_data_object_constructors||{};var ensure_data_type_data_object_constructor=function(data_type_name){if(!jsgui.map_data_type_data_object_constructors[data_type_name]){var dto=jsgui.data_types_info[data_type_name];var dtc=Data_Object.extend({fields:dto});dtc.prototype._data_type_name=data_type_name;jsgui.map_data_type_data_object_constructors[data_type_name]=dtc}return jsgui.map_data_type_data_object_constructors[data_type_name]};jsgui.ensure_data_type_data_object_constructor=ensure_data_type_data_object_constructor;var dti_color=jsgui.data_types_info["color"];jsgui.input_processors["color"]=function(input){console.log("processing color input: "+stringify(input));var input_sig=get_item_sig(input,2);if(input_sig=="[s]")input=input[0];var res=color_preprocessor_parser(input);throw"!!stop";return res};jsgui.ensure_data_type_data_object_constructor("color");jsgui.output_processors["color"]=function(jsgui_color){var res=jsgui.arr_rgb_to_css_hex_6(jsgui_color);return res};var group=function(){var a=arguments;if(a.length==1&&tof(a[0])=="array"){return group.apply(this,a[0])}var res;for(var c=0,l=a.length;c<l;c++){var item=a[c];if(c==0){res=new Collection({context:item._context})}res.push(item)}var C=a[0].constructor;var p=C.prototype;for(i in p){var tpi=tof(p[i]);if(tpi=="function"){(function(i){if(i!="each"&&i!="get"&&i!="add_event_listener"){res[i]=function(){var a=arguments;res.each(function(i2,v){v[i].apply(v,a)})}}})(i)}}return res};var true_vals=function(map){var res=[];for(var i in map){if(map[i])res.push(map[i])}return res};var jsgui=extend(jsgui,{vectorify:vectorify,v_add:v_add,v_subtract:v_subtract,v_multiply:v_multiply,v_divide:v_divide,vector_magnitude:vector_magnitude,distance_between_points:distance_between_points,execute_on_each_simple:execute_on_each_simple,mapify:mapify,filter_map_by_regex:filter_map_by_regex,atof:atof,npx:npx,no_px:no_px,str_arr_mapify:str_arr_mapify,arr_ltrb:arr_ltrb,true_vals:true_vals,validators:validators,__data_id_method:"lazy",str_hex_to_int:str_hex_to_int,arr_rgb_to_css_hex_6:arr_rgb_to_css_hex_6,_data_generators:_data_generators,group:group});var register_data_type=function(data_type_name,def){jsgui.data_types_info[data_type_name]=def};var ensure_data_type_data_object_constructor=function(data_type_name){if(!jsgui.map_data_type_data_object_constructors[data_type_name]){var dto=jsgui.data_types_info[data_type_name];var dtc=Enhanced_Data_Object.extend({fields:dto});jsgui.map_data_type_data_object_constructors[data_type_name]=dtc}return jsgui.map_data_type_data_object_constructors[data_type_name]};var dop=Data_Object.prototype;var do_init=dop.init;var do_get=dop.get;var Enhanced_Data_Object=Data_Object.extend({fields:[["flags",Collection(String)]],_get_input_processors:function(){return jsgui.input_processors},add_flag:function(flag_name){var flags=this.get("flags");var fields=this.fields();if(!flags.has(flag_name)){flags.add(flag_name)}},remove_flag:function(flag_name){var flags=this.get("flags");var has_flag=flags.has(flag_name);if(has_flag){flags.remove(flag_name);console.log("flags "+stringify(flags));flags=this.get("flags");console.log("flags "+stringify(flags))}},has_flag:function(flag_name){var flags=this.get("flags");return flags.has(flag_name)},get:fp(function(a,sig){if(is_defined(this.__data_type_name)){do_get.apply(this,a)}else{if(sig=="[s]"){if(!this.fc)this.fc=new Fields_Collection({});var fc=this.fc;var field_name=a[0];var field=fc.get(field_name);if(field_name.indexOf(".")>-1){var arr_field_names=field_name.split(".");var level=0,l=arr_field_names.length;var current_obj=this,new_obj,fname;while(level<l){fname=arr_field_names[level];new_obj=current_obj.get(fname);level++;current_obj=new_obj}return current_obj}if(field){if(!this._[field_name]){var sig_field=get_item_sig(field,20);if(sig_field=="[s,[s,u]]"){var stack=(new Error).stack;console.log(stack)}if(sig_field=="[s,s,o]"){var field_name=field[0];var field_type_name=field[1];var field_info=field[2];if(field_type_name=="collection"){this._[field_name]=new Collection({context:this._context});return this._[field_name]}else{if(field_type_name=="ordered_string_list"){var osl=new Ordered_String_List;this._[field_name]=osl;return this._[field_name]}else if(field_type_name=="string"){var dv=new Data_Value({context:this._context});if(field_info.default){dv.set(field_info.default)}this._[field_name]=dv;dv.parent(this);return this._[field_name]}else{var default_value=field_info.default;var dtoc=ensure_data_type_data_object_constructor(field_type_name);var context=this.context;if(context){var field_val=new dtoc({context:this._context})}else{var field_val=new dtoc}if(is_defined(default_value)){field_val.set(default_value)}field_val.parent(this);this._[field_name]=field_val;return this._[field_name]}}}else if(sig_field=="[s,s]"){var field_name=field[0];var field_type_name=field[1];if(field_type_name=="collection"){var coll=new jsgui.Collection({context:this._context});coll.parent(this);this._[field_name]=coll;return this._[field_name]}else if(field_type_name=="control"){return undefined}else if(field_type_name=="string"){var dv=new Data_Value;dv.parent(this);this._[field_name]=dv}else{var input_processors;var data_type_info;var module_jsgui=this._module_jsgui;if(module_jsgui){input_processors=module_jsgui.input_processors;data_types_info=module_jsgui.data_types_info;object_constructor=module_jsgui.map_data_type_data_object_constructors[field_type_name];if(object_constructor){var obj=new object_constructor({context:this._context});obj.parent(this);this._[field_name]=obj;return obj}}}return this._[field_name]}else if(sig_field=="[s,[s,s]]"){var field_name=field[0];var field_info=field[1];if(field_info[0]=="collection"){var collection_type_name=field_info[1];var ncoll=new jsgui.Collection({context:this._context});ncoll.parent(this);this._[field_name]=ncoll;return this._[field_name]}}else if(sig_field=="[s,[s,o]]"){var field_name=field[0];var field_info=field[1];var data_type_name=field_info[0];if(data_type_name=="collection"){var objDef=field_info[1];var ncoll=new jsgui.Collection({context:this._context});console.log("objDef "+stringify(objDef));ncoll.fields(objDef);if(this._context)ncoll._context=this._context;ncoll.parent(this);this._[field_name]=ncoll;return this._[field_name]}}}else{return this._[field_name]}}else{var res=ll_get(this._,a[0]);return res}}else if(a.l==0){return this._}}})});Enhanced_Data_Object.extend=function(prop,namespcExtension,propsToMerge){var res=Data_Object.extend.call(this,prop,namespcExtension,propsToMerge);if(prop.flags){res._flags=prop.flags}return res};jsgui.ensure_data_type_data_object_constructor=ensure_data_type_data_object_constructor;Enhanced_Data_Object.map_data_type_data_object_constructors=Data_Object.map_data_type_data_object_constructors;Enhanced_Data_Object.Mini_Context=Data_Object.Mini_Context;Data_Object.set_Enhanced_Data_Object(Enhanced_Data_Object);Enhanced_Data_Object.register_data_type=register_data_type;extend(jsgui.data_types_info,{border_style:["any",["solid","dotted","dashed"]],distance:["n_units","px"],single_border:["indexed_array",[["width","distance"],["style","border_style"],["color","color"]]],border:["oltrb","single_border"],margin:["oltrb","distance"],size:["indexed_array",["distance",["width","height"]]],control_collection:["DataCollection","control"],dom_attributes:"ordered_string_list",control_dom:{node:"object",attributes:"dom_attributes",tagName:"string"},control:{style:"style",id:"context_id",dom:"control_dom",class_name:"string"},style:{border:"border",margin:"margin",cursor:["any",["auto","crosshair","default","e-resize","help","move","n-resize","ne-resize","nw-resize","pointer","progress","s-resize","se-resize","sw-resize","text","w-resize","wait","inherit"]]}});Enhanced_Data_Object.register_data_type("control_dom",jsgui.data_types_info["control_dom"]);Enhanced_Data_Object.register_data_type("dom_attributes",jsgui.data_types_info["dom_attributes"]);ensure_data_type_data_object_constructor("control_dom");jsgui.input_processors["distance"]=function(input){return jsgui.input_processors["n_units"]("px",input)};jsgui.input_processors["margin"]=function(input){return jsgui.input_processors["optional_array"](["left","top","right","bottom"],"distance",input)};jsgui.input_processors["size"]=function(input){return jsgui.input_processors["indexed_array"](["width","height"],"distance",input)};jsgui.output_processors["string"]=function(value){return value};var get_inline_css_dict_from_style=function(style,page_context){var style_info=jsgui.data_types_info["style"];var css_style_dict={};each(style,function(i,v){var dt_info_style_item_name=style_info[i];var dti_style_item=data_type_instance(dt_info_style_item_name);var style_rule=dti_style_item.output(v);if(tof(style_rule)=="string"){css_style_dict[i]=style_rule}else{each(style_rule,function(subrule_name,subrule_value){css_style_dict[subrule_name]=subrule_value})}});return css_style_dict};var apply_jsgui_style_rule_to_css_style=function(style,style_rule_name,style_rule_value){if(fns_jsgui_style_item_to_inline_css_item[style_rule_name]){var inline_style_dict=fns_jsgui_style_item_to_inline_css_item[style_rule_name](style_rule_value);each(inline_style_dict,function(i2,v2){style[i2]=v2})}};var styles_dict_to_string=function(styles_dict){var res="",first=true;each(styles_dict,function(i,v){if(typeof v=="number"){v=v+""}if(typeof v!="string"){throw"jsgui: styles_dict_to_string: Only string css styles supported. Jsgui styles must be translated to css before use here."}else{res=res+i+": "+v+";"}});return res};var _bind_dom_event=function(dom_node,event_name,fn){var unbind=_unbind_dom_event(dom_node,event_name,fn);return unbind};var _unbind_dom_event=function(dom_node,event_name,fn){};var edo_init=Enhanced_Data_Object.prototype.init;var do_init=Data_Object.prototype.init;var that,dom,flags,css_flags,spec_content,tsc,arr,res,dom_attrs;var parse_style_attribute_to_map=function(str_style){str_style=str_style.replace(/; /g,";");str_style=str_style.replace(/: /g,":");var rules=str_style.split(";");var rule_nvps=[];var map_rules={};each(rules,function(i,rule){if(rule){var sRule=rule.split(":");rule_nvps.push(sRule);map_rules[sRule[0]]=sRule[1]}});return map_rules};var style_attribute_map_to_string=function(map_style){var arr_res=[];var first=true;each(map_style,function(i,v){if(!first){arr_res.push(";")}arr_res.push(i);arr_res.push(":");arr_res.push(v);first=false});return arr_res.join("")};var getStyle=function(el,property_name){if(el.currentStyle)var y=el.currentStyle[property_name];else if(window.getComputedStyle);var y=document.defaultView.getComputedStyle(el,null).getPropertyValue(property_name);return y};var Control=Enhanced_Data_Object.extend({fields:[["content","collection"],["dom","control_dom"],["css_flags",Collection(String)]],connect_fields:true,mod_link:function(){return jsgui},init:function(spec){spec=spec||{};this.mapListeners={};do_init.call(this,spec);this.__type_name="control";this.__type="control";if(!this._abstract){var tagName=spec.tagName||spec.tag_name||"div";this.set("dom.tagName",tagName);this._icss={};spec_content=spec.content;if(spec_content){tsc=tof(spec_content);if(tsc=="array"){throw"Content array not yet supported here."}else if(tsc=="string"||tsc=="control"){this.content().add(spec_content)}}if(spec.el){this.set("dom.el",spec.el)}var that=this;if(spec.size){var size=spec.size;var t_size=tof(size);if(t_size=="array"){var width=size[0];var height=size[1];this.set("dom.attributes.style","width: "+width+"px; height: "+height+"px;")}}if(spec["class"]){this.set("dom.attributes.class",spec["class"])}var content=this.get("content");content._parent=this;content.on("change",function(e_change){})}},post_init:function(spec){if(spec&&spec.id===true){this.set("dom.attributes.id",this._id())}},add_css_flag:function(flag_name){var css_flags=this.get("css_flags");if(!css_flags.has(flag_name)){css_flags.add(flag_name)}},remove_css_flag:function(flag_name){var css_flags=this.get("css_flags");if(css_flags.has(flag_name)){css_flags.remove(flag_name)}},has_css_flag:function(flag_name){var css_flags=this.get("css_flags");return css_flags.has(flag_name)},_get_amalgamated_style:function(arr_contexts){return clone(this._.style)},_get_rendered_inline_css_dict:function(){var ast=this.get_amalgamated_style();var inline_css_dict=get_inline_css_dict_from_style(ast);return inline_css_dict},property_css_transition_duration:function(style_property_name){if(this.has("_.s.transition")){var tr=this._.s.transition;if(tr[style_property_name]){var dur=tr[style_property_name][0];return dur}}},has:function(item_name){var arr=item_name.split(".");var c=0,l=arr.length;var i=this;var s;while(c<l){s=arr[c];if(typeof i[s]=="undefined"){return false}i=i[s];c++}return i},renderDomAttributes:function(){if(this.beforeRenderDomAttributes){this.beforeRenderDomAttributes()}var dom_attrs=this.get("dom.attributes");var arr=[];if(dom_attrs){dom_attrs.each(function(i,v){arr.push(" ",i,'="',v,'"')})}return arr.join("")},renderBeginTagToHtml:function(){var tagName=this.get("dom.tagName"),res;if(tagName===false){res=""}else{res=["<",tagName,this.renderDomAttributes(),">"].join("")}return res},renderEndTagToHtml:function(){var dom=this.get("dom");var tagName=dom.get("tagName"),res;var noClosingTag=dom.get("noClosingTag");if(tagName===false||noClosingTag){res=""}else{res=["</",tagName,">"].join("")}return res},renderHtmlAppendment:function(){return this.htmlAppendment||""},renderEmptyNodeJqo:function(){return[this.renderBeginTagToHtml(),this.renderEndTagToHtml(),this.renderHtmlAppendment()].join("")},iterate_this_and_subcontrols:function(ctrl_callback){ctrl_callback(this);var content=this.get("content");var that=this;content.each(function(i,v){tv=tof(v);if(tv=="string"){}if(tv=="data_value"){}else{v.iterate_this_and_subcontrols.call(v,ctrl_callback)}})},all_html_render:function(callback){if(callback){var that=this;var arr_waiting_controls=[];this.iterate_this_and_subcontrols(function(control){if(control.__status=="waiting")arr_waiting_controls.push(control)});if(arr_waiting_controls.length==0){var html=this.all_html_render();callback(null,html)}else{var c=arr_waiting_controls.length;var complete=function(){that.pre_all_html_render();var dom=that.get("dom");if(dom){var html=[that.renderBeginTagToHtml(),that.all_html_render_internal_controls(),that.renderEndTagToHtml(),that.renderHtmlAppendment()].join("");callback(null,html)}};each(arr_waiting_controls,function(i,control){control.on("ready",function(e_ready){c--;if(c==0){complete()}})})}}else{this.pre_all_html_render();var dom=this.get("dom");if(dom){return[this.renderBeginTagToHtml(),this.all_html_render_internal_controls(),this.renderEndTagToHtml(),this.renderHtmlAppendment()].join("")}}},render_content:function(){var content=this.get("content");var contentLength=content.length();var res=new Array(contentLength);var tn,output;content.each(function(i,n){tn=tof(n);if(tn=="string"){res.push(jsgui.output_processors["string"](n))}if(tn=="data_value"){res.push(jsgui.output_processors["string"](n.get()))}else{res.push(n.all_html_render())}});return res.join("")},all_html_render_internal_controls:function(){return this.render_content()},pre_all_html_render:function(){},bind_dom_event:function(evt_name,evt_handler){var n=this.domNode();if(n){n.addEventListener(evt_name,evt_handler,false)}},unbind_dom_event:function(evt_name,evt_handler){var n=this.domNode();if(n){n.removeEventListener(evt_name,evt_handler,false)}},bind_ctrl_event:function(evt_name,evt_handler){var ceen=ll_ensure(this,"_.bound_ctrl_events."+evt_name,[]);ceen.push(evt_handler)},trigger_ctrl_event:function(evt_name){var a=arr_like_to_arr(arguments),p=[];if(a.length>1){p=a.slice(1)}var ce=this._.bound_ctrl_events,that=this;if(ce){if(ce[evt_name]){each(ce[evt_name],function(i,v){v.apply(that,p)})}}},compose:function(){},wait:function(callback){setTimeout(function(){callback()},0)},visible:function(callback){this.style("display","block",callback)},transparent:function(callback){this.style("opacity",0,callback)},opaque:function(callback){return this.style({opacity:1},callback)},chain:function(arr_chain,callback){var pos_in_chain=0;var that=this;var process_chain=function(){if(pos_in_chain<arr_chain.length){var item=arr_chain[pos_in_chain];var t_item=tof(item);if(t_item=="array"){var count=item.length;var cb=function(){count--;if(count==0){pos_in_chain++;process_chain()}};each(item,function(i,v){that.fn_call(v,function(){cb()})})}else{that.fn_call(item,function(){pos_in_chain++;process_chain()})}}else{if(callback){callback.call(that)}}};process_chain()},fn_call:function(call,callback){var t=tof(call);var fn,params,that=this;if(t=="string"){fn=this[call];params=[];if(callback){return fn.call(this,callback)}else{return fn.call(this)}}if(t=="array"){fn=this[call[0]];params=call.slice(1);if(callback)params.push(callback);return fn.apply(this,params)}if(t=="object"){var count=0;each(call,function(i,v){count++});each(call,function(i,v){var cb=function(){count--;if(count==0){callback.call(that)}};that.fn_call([i,v],cb)})}},transition:function(value,callback){return this.style({transition:value},callback)},transit:fp(function(a,sig){var that=this;var unshelled_sig=remove_sig_from_arr_shell(sig);if(unshelled_sig=="[[n,s],o]"){return this.transit(a[0][0],a[0][1])}if(sig=="[[[n,s],o],f]"){var transit=a[0];var callback=a[1];var duration_and_tf=transit[0];var map_values=transit[1];this.transit(duration_and_tf,map_values,callback)}else if(sig=="[[n,s],o,f]"){var duration_and_tf=a[0];var map_values=a[1];var callback=a[2];var transition={};each(map_values,function(i,v){transition[i]=duration_and_tf});that.transition(transition);each(map_values,function(i,v){that.style(i,v)})}else if(a.length==2){var duration_and_tf=a[0];var duration_and_tf=a[0];var map_values=a[1];var transition={};each(map_values,function(i,v){transition[i]=duration_and_tf});that.transition(transition);each(map_values,function(i,v){that.style(i,v)})}}),out:function(property_name){var dti_control=data_type_instance("control");var prop_ref=dti_control.nested_get_property_reference([this,"_"],property_name,true);var item_type=prop_ref[2];var dti_item=data_type_instance(item_type);var out_val=dti_item.output(prop_ref[0][prop_ref[1]]);return out_val},page_context:function(val){if(typeof val=="undefined"){if(is_defined(this._.page_context)){return this._.page_context}else{if(jsgui.page_context){return jsgui.page_context}}}else{this._.page_context=val}},add_control:function(new_content){return this.get("content").add(new_content)},add:function(new_content){var tnc=tof(new_content);if(tnc=="array"){var res=[],that=this;each(new_content,function(i,v){res.push(that.add(v))});return res}else{if(!new_content._context){if(this._context){new_content._context=this._context}}var inner_control=this.get("inner_control");if(inner_control){return inner_control.get("content").add(new_content)}else{return this.get("content").add(new_content)}}},insert_before:function(target){var target_parent=target.parent().parent();var target_index=target._index;var content=target_parent.get("content");content.insert(this,target_index)},stringify:function(){var res=[];res.push("Control("+stringify(this._)+")");return res.join("")},style:fp(function(a,sig){var style_name,style_value,modify_dom=true;if(sig=="[s]"){var styleName=a[0];console.log("get style "+styleName);var el=this.get("dom.el");var res=getComputedStyle(el)[styleName];return res}if(sig=="[s,s,b]"){var styleName=a[0];var styleValue=a[1];var modifyDom=a[2]}if(sig=="[s,s]"){var styleName=a[0];var styleValue=a[1]}if(styleName&&typeof styleValue!=="undefined"){this._icss[styleName]=styleValue;var str_css="";each(this._icss,function(item_style_name,item_style_value){str_css=str_css+item_style_name+":"+item_style_value+";"});if(modify_dom){this.set("dom.attributes.style",str_css)}}var that=this;if(sig=="[o]"){each(a[0],function(i,v){that.style(i,v,false)});var style=this.get("dom.attributes.style");var el=this.get("dom.el");if(el){el.style.cssText=style}}}),active:function(){var id=this._id();var domAttributes=this.get("dom.attributes");domAttributes.set("data-jsgui-id",id);domAttributes.set("data-jsgui-type",this.__type_name);this.get("content").each(function(i,ctrl){var tCtrl=tof(ctrl);if(tCtrl=="control"){ctrl.active()}})},find_selection_scope:function(){var res=this.get("selection_scope");if(res)return res;var parent=this.get("parent");if(parent)return parent.find_selection_scope()},_add_event_listener:fp(function(a,sig){if(sig=="[s,f]"){var event_name=a[0];var listener=this.mapListeners[event_name];var that=this;var el=this.get("dom.el");Enhanced_Data_Object.prototype.add_event_listener.apply(this,a)}}),click:function(handler){this.add_event_listener("click",handler)},hover:function(fn_in,fn_out){this.add_event_listener("mouseover",function(e){fn_in()});this.add_event_listener("mouseout",function(e){fn_out()})},add_class:function(class_name){console.log("Control add_class "+class_name);var cls=this.get("dom.attributes.class");var el=this.get("dom.el");if(!cls){this.set("dom.attributes.class",class_name)}else{var tCls=tof(cls);console.log("tCls "+tCls);if(tCls=="object"){cls[class_name]=true;
var arr_class=[];each(cls,function(i,v){if(v)arr_class.push(i)});var str_class=arr_class.join(" ");el.className=str_class}else if(tCls=="data_value"){var val=cls.value();var arr_classes=val.split(" ");var already_has_class=false,l=arr_classes.length,c=0;while(c<l&!already_has_class){if(arr_classes[c]==class_name){already_has_class=true}c++}if(!already_has_class){arr_classes.push(class_name)}var str_cls=arr_classes.join(" ");this.set("dom.attributes.class",str_cls)}else if(tCls=="string"){var arr_classes=cls.split(" ");var already_has_class=false,l=arr_classes.length,c=0;while(c<l&!already_has_class){if(arr_classes[c]==class_name){already_has_class=true}c++}if(!already_has_class){arr_classes.push(class_name)}var str_cls=arr_classes.join(" ");this.set("dom.attributes.class",str_cls)}}},remove_class:function(class_name){var cls=this.get("dom.attributes.class");var el=this.get("dom.el");if(cls){var tCls=tof(cls);if(tCls=="object"){var arr_class=[];each(cls,function(i,v){if(i==class_name)cls[i]=false;if(cls[i])arr_class.push(i)});var str_class=arr_class.join(" ");this.set("dom.attributes.class",str_cls)}if(tCls=="string"){console.log("cls",cls);var arr_classes=cls.split(" ");var arr_res=[];var l=arr_classes.length,c=0;console.log("arr_classes",arr_classes);while(c<l){if(arr_classes[c]!=class_name){arr_res.push(arr_classes[c])}c++}var str_cls=arr_res.join(" ");this.set("dom.attributes.class",str_cls)}if(tCls=="data_value"){var cls2=cls.value();var arr_classes=cls2.split(" ");var arr_res=[];var l=arr_classes.length,c=0;while(c<l){if(arr_classes[c]!=class_name){arr_res.push(arr_classes[c])}c++}var str_cls=arr_res.join(" ");this.set("dom.attributes.class",str_cls)}}},hover_class:function(class_name){var that=this;that.hover(function(e_in){that.add_class(class_name)},function(e_out){that.remove_class(class_name)})},find_selected_ancestor_in_scope:function(){var s=this.get("selection_scope");var parent=this.get("parent");var ps=parent.get("selection_scope");if(s==ps){var psel=parent.get("selected");if(psel&&psel.value&&psel.value()==true){return parent}else{return parent.find_selected_ancestor_in_scope()}}},remove:function(){var el=this.get("dom.el");if(el){if(el.parentNode){el.parentNode.removeChild(el)}}},shallow_copy:function(){console.log("Control shallow_copy");var res=new Control({context:this._context});var da=this.get("dom.attributes");var cl=da.get("class");console.log("cl "+stringify(cl));console.log("cl "+tof(cl));var map_class_exclude={"bg-light-yellow":true,selected:true};each(cl,function(i,v){if(i&&!map_class_exclude[i])res.add_class(i)});var res_content=res.get("content");this.get("content").each(function(i,v){console.log("v "+v);console.log("tof v "+tof(v));if(tof(v)=="data_value"){res_content.add(v.value())}else{res_content.add(v.shallow_copy())}});return res},size:fp(function(a,sig){if(sig=="[]"){var el=this.get("dom.el");var w=parseInt(getStyle(el,"width"),10);var h=parseInt(getStyle(el,"height"),10);var res=[w,h];return res}if(sig=="[a]"){this.style({width:a[0][0]+"px",height:a[0][1]+"px"})}}),offset:fp(function(a,sig){if(sig=="[]"){var el=this.get("dom.el");var res=[el.offsetLeft,el.offsetTop];return res}if(sig=="[a]"){this.style({left:a[0]+"px",top:a[1]+"px"})}}),clear:function(){return this.get("content").clear()},activate:function(){}});var p=Control.prototype;p._data_generators={context_id:function(){var page_context=this.page_context();var id=page_context.ensure_ctrl_id(this);return id},control_collection:function(){var res=new jsgui.DataCollection;return res}};var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Control.prototype._module_jsgui=jsgui;Control.extend=function(prop,post_init){var _super=this.prototype;initializing=true;var prototype=new this;var for_class={};initializing=false;if(typeof prop==="string"){var data_type_name=prop;var dtis=jsgui.data_types_info;var data_type_info=dtis[data_type_name];for_class[data_type_name]=data_type_name;for_class[data_type_info]=data_type_info;prototype["__type_name"]=data_type_name;prototype["__data_type_info"]=data_type_info;prop={}}var prop_item,t_prop_item,tmp,name,res;for(name in prop){prop_item=prop[name];if(name.charAt(0)==="#"){prototype[name.substring(1)]=prototype[prop_item]}else{t_prop_item=typeof prop_item;if(t_prop_item==="function"){prototype[name]=typeof _super[name]==="function"&&fnTest.test(prop_item)?function(name,fn){return function(){tmp=this._super;this._super=_super[name];res=fn.apply(this,arguments);this._super=tmp;return res}}(name,prop[name]):prop[name]}else if(t_prop_item==="object"||t_prop_item==="boolean"){if(name=="class_name"){for_class["_class_name"]=prop_item}else if(name=="fields"){for_class["_fields"]=prop_item}else if(name=="connect_fields"){for_class["_connect_fields"]=prop_item}else{prototype[name]=prop[name]}}else{prototype[name]=prop[name]}}}var Class=function(){if(!initializing){if(this.init){var that=this;var the_make_function=function(abstract_control){var spec=abstract_control._spec;spec.abstract=null;spec._abstract=null;spec.context=that._context;var instance=new abstract_control.constructor(spec);return instance};var the_add_function=function(abstract_control){var instance=the_make_function(abstract_control);return that.add(instance)};var l=arguments.length;var a2=new Array(l+2);for(var c=0;c<l;c++){a2[c]=arguments[c]}a2[l]=the_add_function;a2[l+1]=the_make_function;this.init.apply(this,a2);if(this.post_init){this.post_init.apply(this,arguments)}if(post_init){post_init.call(this)}}else{var spec=arguments[0]||{};spec.abstract=true;return new Class(spec)}}};Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;for(i in for_class){Class[i]=for_class[i]}if(Class["class_name"]){jsgui.map_classes[Class["class_name"]]=Class}Class._superclass=this;return Class};var prototype_access=function(p,variable_name,fn_name){p[fn_name]=fp(function(a){if(a.l==1){return this.set(variable_name,a[0])}else{return this.get(variable_name)}})};var p=Control.prototype;prototype_access(p,"index","index");prototype_access(p,"id","id");prototype_access(p,"dom.tagName","tagName");prototype_access(p,"dom.attributes","domAttributes");prototype_access(p,"controls","controls");var map_Controls={};var ctrl_init=Control.prototype.init;var ctrl_init_call=Control.prototype.init.call;var escape_html_replacements=[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"],[/"/g,"&quot;"],[/'/g,"&#x27;"],[/\//g,"&#x2F;"]];var escape_html=function(str){if(tof(str)=="data_value")str=str.get();var single_replacement;for(var c=0,l=escape_html_replacements.length;c<l;c++){single_replacement=escape_html_replacements[c];str=str.replace(single_replacement[0],single_replacement[1])}return str};jsgui.textNode=Control.extend({init:function(spec){spec=spec||{};this._super(spec);if(typeof spec=="string"){spec={text:spec}}spec.nodeType=3;if(typeof spec.text!="undefined"){this._.text=spec.text}},all_html_render:function(){var text=this.get("text");var nx=this.get("no_escape");if(nx){res=text||""}else{res=escape_html(text||"")||""}return res}});var shallow_copy=fp(function(a,sig){if(sig=="[a]"){var arr_ctrls=a[0];var res=[];each(arr_ctrls,function(i,v){res.push(v.shallow_copy())});return res}});var constructor_from_type=function(type){console.log("constructor_from_type type "+type);console.log("map_controls_by_type "+stringify(map_controls_by_type))};jsgui=jsgui.extend(jsgui,{get_inline_css_dict_from_style:get_inline_css_dict_from_style,apply_jsgui_style_rule_to_css_style:apply_jsgui_style_rule_to_css_style,styles_dict_to_string:styles_dict_to_string,Control:Control,map_Controls:map_Controls,shallow_copy:shallow_copy});var hover_class=fp(function(a,sig){if(sig=="[c,s]"){var ctrl=a[0];var hover_class=a[1];ctrl.hover(function(e_in){ctrl.add_class(hover_class)},function(e_out){ctrl.remove_class(hover_class)})}});var group_hover_class=fp(function(a,sig){if(sig=="[a,s]"){var res=group(a[0]);var hover_class=a[1];res.hover(function(e_in){res.add_class(hover_class)},function(e_out){res.remove_class(hover_class)});return res}});var get_window_size=function(){var winW,winH;if(document.body&&document.body.offsetWidth){winW=document.body.offsetWidth;winH=document.body.offsetHeight}if(document.compatMode=="CSS1Compat"&&document.documentElement&&document.documentElement.offsetWidth){winW=document.documentElement.offsetWidth;winH=document.documentElement.offsetHeight}if(window.innerWidth&&window.innerHeight){winW=window.innerWidth;winH=window.innerHeight}return[winW,winH]};var findPos=function(obj){var curleft=curtop=0;if(obj.offsetParent){do{curleft+=obj.offsetLeft;curtop+=obj.offsetTop}while(obj=obj.offsetParent);return[curleft,curtop]}};var Selection_Scope=Data_Object.extend({init:function(spec){if(spec.control)this.control=spec.control;this.map_selected_controls={}},select_only:function(ctrl){each(this.map_selected_controls,function(i,v){if(v&&v!==ctrl){v.set("selected",false);v.remove_class("selected")}});this.map_selected_controls={};this.map_selected_controls[ctrl._id()]=ctrl;ctrl.set("selected",true);ctrl.add_class("selected");this.trigger("change")},deselect_ctrl_content:function(ctrl){var cs=ctrl.get("selection_scope");var msc=this.map_selected_controls;var that=this;ctrl.get("content").each(function(i,v){var tv=tof(v);if(tv=="control"){v.remove_class("selected");v.set("selected",false);var id=v._id();if(msc[id])msc[id]=false;that.deselect_ctrl_content(v)}});this.trigger("change")},select_toggle:function(ctrl){var sel=ctrl.get("selected");var msc=this.map_selected_controls;var id=ctrl._id();if(!sel){var sel_anc=ctrl.find_selected_ancestor_in_scope();if(sel_anc){console.log("1) not selecting because a selected ancestor in the selection scope has been found.")}else{ctrl.set("selected",true);this.deselect_ctrl_content(ctrl);ctrl.add_class("selected");msc[id]=ctrl}}else{var tsel=tof(sel);if(tsel=="data_value"){var val=sel.get();if(val){ctrl.remove_class("selected");ctrl.set("selected",false);msc[id]=false}else{var sel_anc=ctrl.find_selected_ancestor_in_scope();if(sel_anc){console.log("2) not selecting because a selected ancestor in the selection scope has been found.")}else{ctrl.set("selected",true);this.deselect_ctrl_content(ctrl);ctrl.add_class("selected");msc[id]=ctrl}}}if(tsel=="boolean"){if(sel){ctrl.remove_class("selected");ctrl.set("selected",false);msc[id]=false}else{var sel_anc=ctrl.find_selected_ancestor_in_scope();if(sel_anc){console.log("2) not selecting because a selected ancestor in the selection scope has been found.")}else{this.deselect_ctrl_content(ctrl);ctrl.set("selected",true);ctrl.add_class("selected");msc[id]=ctrl}}}}this.trigger("change")}});var mapDomEventNames={click:true,mousedown:true,mouseup:true,mousemove:true,mouseover:true,mouseout:true,blur:true,focus:true,keydown:true,keyup:true,keypress:true,contextmenu:true,touchstart:true,touchmove:true,touchend:true,abort:true,canplay:true,canplaythrough:true,durationchange:true,emptied:true,ended:true,error:true,loadeddata:true,loadedmetadata:true,loadstart:true,pause:true,play:true,playing:true,progress:true,ratechange:true,seeked:true,seeking:true,stalled:true,suspend:true,timeupdate:true,volumechange:true,waiting:true};var id_before__=function(id){var pos1=id.lastIndexOf("_");var res=id.substr(0,pos1);return res};var num_after=function(id){var pos1=id.lastIndexOf("_");var res=parseInt(id.substr(pos1+1),10);return res};Control=jsgui.Control=jsgui.Control.extend({fields:{selection_scope:Object},init:function(spec){this._super(spec)},bcr:fp(function(a,sig){if(sig=="[]"){var el=this.get("dom.el");var bcr=el.getBoundingClientRect();var res=[[bcr.left,bcr.top],[bcr.right,bcr.bottom],[bcr.width,bcr.height]];return res}}),activate_recursive:function(el_param){console.log("activate_recursive");var max_typed_ids=jsgui.max_typed_ids||{};var map_jsgui_els=jsgui.map_jsgui_els||{};var map_jsgui_types=jsgui.map_jsgui_types||{};var arr_controls=jsgui.arr_controls||[];var el=this.get("dom.el");if(!el)el=this.set("dom.el",el_param);var context=this._context;var map_controls=context.map_controls;recursive_dom_iterate(el,function(el){var nt=el.nodeType;if(nt==1){var jsgui_id=el.getAttribute("data-jsgui-id");if(jsgui_id){var ib=id_before__(jsgui_id);var num=num_after(jsgui_id);if(!max_typed_ids[ib]){max_typed_ids[ib]=num}else{if(num>max_typed_ids[ib])max_typed_ids[ib]=num}map_jsgui_els[jsgui_id]=el;var jsgui_type=el.getAttribute("data-jsgui-type");map_jsgui_types[jsgui_id]=jsgui_type}}});context.set_max_ids(max_typed_ids);each(map_jsgui_els,function(jsgui_id,el){var l_tag_name=el.tagName.toLowerCase();if(jsgui_id){var type=map_jsgui_types[jsgui_id];var Cstr=context.map_Controls[type];if(Cstr){var ctrl=new Cstr({context:context,_id:jsgui_id,el:el});map_controls[jsgui_id]=ctrl;arr_controls.push(ctrl);if(l_tag_name==="html"){context.ctrl_document=ctrl}}else{console.log("Missing context.map_Controls for type "+type+", using generic Control");var ctrl=new Control({context:context,_id:jsgui_id,el:el});map_controls[jsgui_id]=ctrl;arr_controls.push(ctrl)}}});recursive_dom_iterate_depth(el,function(el2){var nt=el2.nodeType;if(nt==1){var jsgui_id=el2.getAttribute("data-jsgui-id");console.log("jsgui_id "+jsgui_id);if(jsgui_id){var ctrl=map_controls[jsgui_id];console.log("ctrl "+ctrl);if(ctrl&&!ctrl.__active)ctrl.activate(el2)}}})},add_event_listener:fp(function(a,sig){this._super.apply(this,a);if(sig=="[s,f]"){var event_name=a[0];if(mapDomEventNames[a[0]]){var listener=this.mapListeners[event_name];var that=this;var el=this.get("dom.el");if(el){if(!listener){listener=this.mapListeners[event_name]=function(e){var res_raise=that.raise(event_name,e);var any_are_false=false;var c=0,l=res_raise.length;while(!any_are_false&&c<l){if(res_raise[c]===false){any_are_false=true}c++}if(any_are_false){e.preventDefault();return false}};el.addEventListener(event_name,listener,false)}}}}}),activate:function(el){console.log("enh ctrl activate el",el);this.__active=true;if(el){console.log("setting dom el");this.set("dom.el",el)}this.activate_dom_attributes();this.activate_content_controls();this.activate_content_listen();this.activate_other_changes_listen()},activate_other_changes_listen:function(){var dom_attributes=this.get("dom.attributes");var el=this.get("dom.el");dom_attributes.on("change",function(e_change){var property_name=e_change.name,dval=e_change.value;if(tof(dval)=="string"){}else{dval=dval.value()}el.setAttribute(property_name,dval)})},activate_content_listen:function(){var content=this.get("content");var that=this;content.on("change",function(e_change){console.log("activated control content change");var el=that.get("dom.el");var type=e_change.type;if(type=="insert"){var item=e_change.item;var itemDomEl=item.get("dom.el");if(!itemDomEl){var temp_div=e_change.item._context.document.createElement("div");temp_div.innerHTML=e_change.item.all_html_render();itemDomEl=temp_div.childNodes[0];e_change.item.set("dom.el",itemDomEl)}el.appendChild(itemDomEl)}if(type=="clear"){el.innerHTML=""}})},activate_dom_attributes:function(){var el=this.get("dom.el");console.log("el",el);var that=this;var dom_attributes=this.get("dom.attributes");for(var i=0,attrs=el.attributes,l=attrs.length;i<l;i++){var item=attrs.item(i);var name=item.name;var value=item.value;if(name=="data-jsgui-id"){}else if(name=="data-jsgui-type"){}else if(name=="style"){var map_inline_css=this._icss;var arr_style_items=value.split(";");for(var c=0,l2=arr_style_items.length;c<l2;c++){var style_item=arr_style_items[c];var arr_style_item=style_item.split(":");if(arr_style_item[0]){map_inline_css[arr_style_item[0]]=arr_style_item[1]}}}else if(name=="data-jsgui-fields"){var str_properties=value;if(str_properties){var s_pre_parse=str_properties.replace(/\[DBL_QT\]/g,'"').replace(/\[SNG_QT\]/g,"'").replace(/'\'/g,'"');console.log("s_pre_parse",s_pre_parse);var props=JSON.parse(s_pre_parse);this.set(props);var ss=this.get("selection_scope");if(ss&&ss.value()===true){var selection_scope=new Selection_Scope({control:this});this.set("selection_scope",selection_scope)}}}else{dom_attributes.set(name,value)}}},hide:function(){this.add_class("hidden")},show:function(){this.remove_class("hidden")},context_menu:fp(function(a,sig){var menu_def;if(sig=="[o]"||sig=="[a]"){menu_def=a[0]}var Context_Menu=Context_Menu||require("./controls/advanced/context-menu");var context_menu;var that=this;var ctrl_html_root=this._context.ctrl_document;var body=ctrl_html_root.body();var show_context_menu=fp(function(a,sig){var pos;if(sig=="[a]"){pos=a[0]}console.log("show_context_menu pos:",pos);console.log("context_menu",context_menu);if(!context_menu){context_menu=new Context_Menu({context:that._context,value:menu_def});if(pos){context_menu.style({left:pos[0]-1+"px",top:pos[1]-1+"px"})}else{context_menu.style({left:"100px",top:"100px"})}var context=that._context;setTimeout(function(){body.add(context_menu);setTimeout(function(){ctrl_html_root.one("mouseup",function(e_mouseup){console.log("");console.log("one mouseup");if(context_menu){context_menu.remove()}})},20)},0)}else{if(pos){context_menu.style({left:pos[0]-1+"px",top:pos[1]-1+"px"})}else{context_menu.style({left:"100px",top:"100px"})}setTimeout(function(){body.add(context_menu);setTimeout(function(){ctrl_html_root.one("mouseup",function(e_mouseup){console.log("");console.log("one mouseup");if(context_menu){context_menu.remove()}})},20)},0)}});this.on("click",function(e_click){console.log("e_click",e_click)});this.on("contextmenu",function(e_contextmenu){return false});this.on("mousedown",function(e_mousedown){var int_button=e_mousedown.which;if(int_button==3){e_mousedown.preventDefault();window.event.returnValue=false;return false}});this.on("mouseup",function(e_mouseup){var int_button=e_mouseup.which;if(int_button==3){console.log("right button");e_mouseup.preventDefault();window.event.returnValue=false;var pos=[e_mouseup.pageX,e_mouseup.pageY];show_context_menu(pos);return false}})}),activate_content_controls:function(){var el=this.get("dom.el");var context=this._context;var ctrl_fields={};var that=this;var str_ctrl_fields=el.getAttribute("data-jsgui-ctrl-fields");if(str_ctrl_fields){ctrl_fields=JSON.parse(str_ctrl_fields.replace(/'/g,'"'))}each(ctrl_fields,function(i,v){var referred_to_control=context.map_controls[v];that.set(i,referred_to_control)});var cns=el.childNodes;var content=this.get("content");for(var c=0,l=cns.length;c<l;c++){var cn=cns[c];var nt=cn.nodeType;if(nt==1){var cn_jsgui_id=cn.getAttribute("data-jsgui-id");var cctrl=context.map_controls[cn_jsgui_id];content.push(cctrl)}if(nt==3){var val=cn.nodeValue;content.push(val)}}},drag:function(fn_mousedown,fn_begin,fn_move,fn_end){var screen_down_x,screen_down_y;var ctrl_html_root=this._context.ctrl_document;this.add_event_listener("mousedown",function(e){screen_down_x=e.screenX;screen_down_y=e.screenY;var drag_initiated=false;fn_mousedown(e);var first=true;var handle_move=function(e){console.log("handle_move");var screen_move_x=e.screenX;var screen_move_y=e.screenY;var screen_offset_x=screen_move_x-screen_down_x;var screen_offset_y=screen_move_y-screen_down_y;if(first){ctrl_html_root.add_class("cursor-default");first=false}var e={offsetX:screen_offset_x,offsetY:screen_offset_y,screenX:screen_move_x,screenY:screen_move_y,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY};if(!drag_initiated){var dbp=jsgui.distance_between_points([[0,0],[screen_offset_x,screen_offset_y]]);var drag_initiation_distance=16;if(dbp>=16){drag_initiated=true;ctrl_html_root.add_class("dragging");fn_begin(e)}}if(drag_initiated){fn_move(e)}};var handle_mouseup=function(e){ctrl_html_root.off("mousemove",handle_move);ctrl_html_root.off("mouseup",handle_mouseup);ctrl_html_root.remove_class("dragging");ctrl_html_root.remove_class("cursor-default");var screen_mouseup_x=e.screenX;var screen_mouseup_y=e.screenY;var screen_offset_x=screen_mouseup_x-screen_down_x;var screen_offset_y=screen_mouseup_y-screen_down_y;console.log("screen_offset_x",screen_offset_x,"screen_offset_y",screen_offset_y);var e={offsetX:screen_offset_x,offsetY:screen_offset_y};fn_end(e)};ctrl_html_root.on("mousemove",handle_move);ctrl_html_root.on("mouseup",handle_mouseup)})},drag_handle_to:function(ctrl){console.log("drag_handle_to");var mousedown_offset_from_ctrl_lt;var ctrl_el=ctrl.get("dom.el");this.drag(function(e_mousedown){var target=e_mousedown.target;var targetPos=findPos(target);console.log("targetPos "+stringify(targetPos));var ctrl_el_pos=findPos(ctrl.get("dom.el"));var e_pos_on_page=[e_mousedown.pageX,e_mousedown.pageY];mousedown_offset_from_ctrl_lt=jsgui.v_subtract(e_pos_on_page,ctrl_el_pos)},function(e_begin){var ctrlSize=ctrl.size();console.log("ctrlSize",ctrlSize);var anchored_to=ctrl.get("anchored_to");if(!anchored_to){}else{ctrl.unanchor()}console.log("drag handle to drag begin")},function(e_move){console.log("move event");var clientX=e_move.clientX;var clientY=e_move.clientY;var window_size=get_window_size();var ctrl_pos=jsgui.v_subtract([clientX,clientY],mousedown_offset_from_ctrl_lt);var offset_adjustment=ctrl.get("offset_adjustment");console.log("offset_adjustment",offset_adjustment);if(offset_adjustment){ctrl_pos=jsgui.v_add(ctrl_pos,offset_adjustment)}if(ctrl_pos[0]<0)ctrl_pos[0]=0;if(ctrl_pos[1]<0)ctrl_pos[1]=0;var ow=ctrl_el.offsetWidth;var oh=ctrl_el.offsetHeight;if(ctrl_pos[0]>window_size[0]-ow)ctrl_pos[0]=window_size[0]-ow;if(ctrl_pos[1]>window_size[1]-oh)ctrl_pos[1]=window_size[1]-oh;ctrl.style({left:ctrl_pos[0]+"px",top:ctrl_pos[1]+"px"});ctrl._context.move_drag_ctrl(e_move,ctrl)},function(e_end){var uo1=ctrl.get("unanchored_offset");console.log("uo1",uo1);ctrl._context.end_drag_ctrl(e_end,ctrl);var uo2=ctrl.get("unanchored_offset");console.log("uo2",uo2);if(uo1&&uo2){ctrl.set("unanchored_offset",null)}ctrl.set("offset_adjustment",null)})},resize_handle_to:function(ctrl,handle_position){console.log("resize_handle_to");if(handle_position=="right-bottom"){var fn_move=function(e_move){console.log("e_move",e_move)};var fn_up=function(e_up){console.log(e_up)};var doc=ctrl._context.ctrl_document;console.log("ctrl._context",ctrl._context);var fn_move=function(e_move){console.log("e_move",e_move)};var fn_up=function(e_up){console.log("e_up",e_up);doc.off("mousemove",fn_move);doc.off("mouseup",fn_up)};ctrl.on("mousedown",function(e_mousedown){console.log("e_mousedown",e_mousedown);doc.on("mousemove",fn_move);doc.on("mouseup",fn_up)})}},selectable:function(ctrl){var that=this;ctrl=ctrl||this;that.click(function(e){var ctrl_key=e.ctrlKey;var meta_key=e.metaKey;if(ctrl_key||meta_key){ctrl.action_select_toggle()}else{ctrl.action_select_only()}})},action_select_only:function(){console.log("this ",this);this.find_selection_scope().select_only(this)},action_select_toggle:function(){this.find_selection_scope().select_toggle(this)},find_selection_scope:function(){var res=this.get("selection_scope");if(res)return res;var parent=this.get("parent");if(parent)return parent.find_selection_scope()},make_full_height:function(){var el=this.get("dom.el");var viewportHeight=document.documentElement.clientHeight;var rect=el.getBoundingClientRect();console.log(rect.top,rect.right,rect.bottom,rect.left);var h=viewportHeight-rect.top;this.style("height",h+"px",true)},grid_9:function(){var res=this.get("grid_9");if(res)return res;res=new Grid_9({context:this._context});res.set("dom.attributes.data-jsgui-type","control");var res_id=res._id();res.set("dom.attributes.data-jsgui-id",res_id);this._context.map_controls[res_id]=res;var el=this.get("dom.el");var html_grid_9=res.all_html_render();var nel=document.createElement("div");nel.innerHTML=html_grid_9;var el_grid_9=nel.childNodes[0];el.insertBefore(el_grid_9,el.childNodes[0]);while(el.childNodes[1]){el_grid_9.childNodes[1].childNodes[1].appendChild(el.childNodes[1])}res.set("dom.el",el_grid_9);res.activate_recursive();var current_content=this.get("content");var res_middle=res.get("content").get(1).get("content").get(1);res_middle.set("content",current_content);this.get("content").clear();this.get("content").add(res);this.set("grid_9",res);return res},ensure_dock_placeholder:function(pos){var grid_9=this.get("grid_9");var g9el=grid_9.get("dom.el");if(grid_9){var dock_placeholder_pos=grid_9.get("dock_placeholder_pos");var t_stripe=grid_9.get("content").get(0);var m_stripe=grid_9.get("content").get(1);var cell_4=m_stripe.get("content").get(1);var cell4_el=cell_4.get("dom.el");if(dock_placeholder_pos){var dpp_val;if(dock_placeholder_pos.value){dpp_val=dock_placeholder_pos.value()}else{dpp_val=dock_placeholder_pos}if(!pos){if(dpp_val=="left"){grid_9.close_placeholder()}if(dpp_val=="top"){grid_9.close_placeholder()}if(dpp_val=="right"){grid_9.close_placeholder()}if(dpp_val=="bottom"){grid_9.close_placeholder()}}}else{if(!pos){}if(pos=="left"){grid_9.open_placeholder("left")}if(pos=="top"){grid_9.open_placeholder("top")}if(pos=="right"){grid_9.open_placeholder("right")}if(pos=="bottom"){grid_9.open_placeholder("bottom")}}}},unanchor:function(){var anchored_to=this.get("anchored_to");anchored_to[0].unanchor_ctrl(this)}});var Grid_9=jsgui.Control.extend({init:function(spec){this._super(spec);this.__type_name=="grid_9";this.set("dom.attributes.class","grid_9");var context=this._context;var arr_v_names=["top","v-middle","bottom"];var arr_h_names=["left","h-middle","right"];if(!spec.el){var c=0;var arr_ctrls=new Array(9);for(var y=0;y<3;y++){var stripe=new jsgui.Control({context:context});stripe.set("dom.attributes.class",arr_v_names[y]);stripe.set("dom.attributes.data-jsgui-type",stripe.__type_name);stripe.set("dom.attributes.data-jsgui-id",stripe._id());this.add(stripe);context.map_controls[stripe._id()]=stripe;for(var x=0;x<3;x++){arr_ctrls[c]=new jsgui.Control({context:context});arr_ctrls[c].set("dom.attributes.class",arr_h_names[x]);arr_ctrls[c].set("dom.attributes.data-jsgui-id",arr_ctrls[c]._id());arr_ctrls[c].set("dom.attributes.data-jsgui-type",arr_ctrls[c].__type_name);stripe.add(arr_ctrls[c]);context.map_controls[arr_ctrls[c]._id()]=arr_ctrls[c];c++}}}},unanchor_ctrl:function(ctrl){var anchored_to=ctrl.get("anchored_to");var zone=anchored_to[2];console.log("unanchor_ctrl zone "+zone);ctrl.remove_class("anchored");var unanchored_offset=ctrl.get("unanchored_offset");console.log("unanchored_offset",unanchored_offset);if(unanchored_offset){if(zone!=="right"){ctrl.set("offset_adjustment",[unanchored_offset[0],0])}}var t_stripe=this.get("content").get(0);var m_stripe=this.get("content").get(1);var cell_4=m_stripe.get("content").get(1);var cell4_el=cell_4.get("dom.el");if(zone=="left"){var cell_3=m_stripe.get("content").get(0);var cell3_el=cell_3.get("dom.el");cell_3.remove_class("open")}if(zone=="right"){var cell_5=this.get("content").get(1).get("content").get(2);cell_5.remove_class("dock-placeholder")}anchored_to[0].close_placeholder(zone);ctrl.set("anchored_to",null);ctrl.set("unanchored_offset",null)},anchor_ctrl:function(ctrl,zone){var x,y,found;if(zone=="left"){x=0;y=1;found=true}if(zone=="top"){x=1;y=0;found=true}if(zone=="right"){x=2;y=1;found=true}if(zone=="bottom"){x=1;y=2;found=true}var t_stripe=this.get("content").get(0);var m_stripe=this.get("content").get(1);var cell_4=m_stripe.get("content").get(1);var cell4_el=cell_4.get("dom.el");if(found){var grid_section=this.get("content").get(y).get("content").get(x);var unanchored_offset=ctrl.offset();ctrl.set("unanchored_offset",unanchored_offset);console.log("unanchored_offset",unanchored_offset);ctrl.add_class("anchored");grid_section.add(ctrl);ctrl.set("anchored_to",[this,grid_section,zone]);var unanchored_size=ctrl.size();ctrl.set("unanchored_size",unanchored_size);if(zone=="left"){console.log("left zone");var cw=document.documentElement.clientWidth;this.style({width:cw+"px"});var cell_3=m_stripe.get("content").get(0);var cell3_el=cell_3.get("dom.el");var c4w=cell4_el.offsetWidth;cell_3.add_class("open");var c3w=cell3_el.offsetWidth;var nw=c4w-c3w;cell_4.style({width:nw+"px"})}if(zone=="right"){var c4w=document.documentElement.clientWidth;var cell_5=this.get("content").get(1).get("content").get(2);cell_5.add_class("dock-placeholder");this.set("open","right");var cell5_el=cell_5.get("dom.el");var c5w=cell5_el.offsetWidth;var nw=c4w-c5w;cell_4.style({width:nw+"px"})}if(zone=="bottom"){var c=document.documentElement.clientHeight;var cell_7=this.get("content").get(2).get("content").get(1);cell_7.add_class("open");this.set("dock_placeholder_pos","bottom");var cell7_el=cell_7.get("dom.el");var c7h=cell7_el.offsetHeight;var nh=c-c7h;m_stripe.style({height:nh+"px"})}}},open_placeholder:function(zone){var t_stripe=this.get("content").get(0);var m_stripe=this.get("content").get(1);var cell_4=m_stripe.get("content").get(1);var cell4_el=cell_4.get("dom.el");if(zone=="left"){var cw=document.documentElement.clientWidth;this.style({width:cw+"px"});var cell_3=m_stripe.get("content").get(0);var cell3_el=cell_3.get("dom.el");var c4w=cell4_el.offsetWidth;cell_3.add_class("dock-placeholder");var c3w=cell3_el.offsetWidth;var nw=c4w-c3w;cell_4.style({width:nw+"px"});this.set("dock_placeholder_pos","left")}if(zone=="top"){var cell_1=t_stripe.get("content").get(1);cell_1.add_class("dock-placeholder");this.set("dock_placeholder_pos","top")}if(zone=="right"){var c4w=document.documentElement.clientWidth;var cell_5=this.get("content").get(1).get("content").get(2);cell_5.add_class("dock-placeholder");this.set("dock_placeholder_pos","right");var cell5_el=cell_5.get("dom.el");var c5w=cell5_el.offsetWidth;var nw=c4w-c5w;cell_4.style({width:nw+"px"})}if(zone=="bottom"){var c=document.documentElement.clientHeight;var cell_7=this.get("content").get(2).get("content").get(1);cell_7.add_class("dock-placeholder");this.set("dock_placeholder_pos","bottom");var cell7_el=cell_7.get("dom.el");var c7h=cell7_el.offsetHeight;var nh=c-c7h;m_stripe.style({height:nh+"px"})}},close_placeholder:function(){var dppos=this.get("dock_placeholder_pos");if(dppos&&dppos.value)dppos=dppos.value();var t_stripe=this.get("content").get(0);var m_stripe=this.get("content").get(1);var cell_4=m_stripe.get("content").get(1);if(dppos=="left"){var el=this.get("dom.el");var g9w=el.offsetWidth;var g9c=this.get("content");var cell_3=m_stripe.get("content").get(0);cell_4.style({width:"100%"});cell_3.remove_class("dock-placeholder");this.set("dock_placeholder_pos",false)}if(dppos=="top"){var cell_1=t_stripe.get("content").get(1);cell_1.remove_class("dock-placeholder");this.set("dock_placeholder_pos",false)}if(dppos=="right"){var cell_5=this.get("content").get(1).get("content").get(2);cell_5.remove_class("dock-placeholder");this.set("dock_placeholder_pos",false);cell_4.style({width:"100%"})}if(dppos=="bottom"){var cell_7=this.get("content").get(2).get("content").get(1);cell_7.remove_class("dock-placeholder");this.set("dock_placeholder_pos",false);m_stripe.style({height:"100%"})}}});var recursive_dom_iterate=function(el,callback){callback(el);var cns=el.childNodes;for(var c=0,l=cns.length;c<l;c++){recursive_dom_iterate(cns[c],callback)}};var recursive_dom_iterate_depth=function(el,callback){var cns=el.childNodes;for(var c=0,l=cns.length;c<l;c++){recursive_dom_iterate_depth(cns[c],callback)}callback(el)};var activate=function(context){ensure_Context_Menu_loaded(function(_Context_Menu){Context_Menu=_Context_Menu;if(!context){throw"jsgui-html-enh activate(context) - need to supply context parameter."}var map_jsgui_els={};var map_jsgui_types={};var arr_controls=[];var max_typed_ids={};var id_before__=function(id){var pos1=id.lastIndexOf("_");var res=id.substr(0,pos1);return res};var num_after=function(id){var pos1=id.lastIndexOf("_");var res=parseInt(id.substr(pos1+1),10);return res};recursive_dom_iterate(document,function(el){var nt=el.nodeType;if(nt==1){var jsgui_id=el.getAttribute("data-jsgui-id");if(jsgui_id){var ib=id_before__(jsgui_id);var num=num_after(jsgui_id);if(!max_typed_ids[ib]){max_typed_ids[ib]=num}else{if(num>max_typed_ids[ib])max_typed_ids[ib]=num}map_jsgui_els[jsgui_id]=el;var jsgui_type=el.getAttribute("data-jsgui-type");map_jsgui_types[jsgui_id]=jsgui_type
}}});context.set_max_ids(max_typed_ids);var map_controls=context.map_controls;each(map_jsgui_els,function(jsgui_id,el){var l_tag_name=el.tagName.toLowerCase();if(jsgui_id){var type=map_jsgui_types[jsgui_id];var Cstr=context.map_Controls[type];if(Cstr){var ctrl=new Cstr({context:context,_id:jsgui_id,el:el});map_controls[jsgui_id]=ctrl;arr_controls.push(ctrl);if(l_tag_name==="html"){context.ctrl_document=ctrl}}else{console.log("Missing context.map_Controls for type "+type+", using generic Control");var ctrl=new Control({context:context,_id:jsgui_id,el:el});map_controls[jsgui_id]=ctrl;arr_controls.push(ctrl)}}});recursive_dom_iterate_depth(document,function(el){var nt=el.nodeType;if(nt==1){var jsgui_id=el.getAttribute("data-jsgui-id");if(jsgui_id){var ctrl=map_controls[jsgui_id];ctrl.__activating==true;ctrl.activate();ctrl.__activating==false}}})})};var core_extension=str_arr_mapify(function(tagName){jsgui[tagName]=Control.extend({init:function(spec){this._super(spec);this.get("dom").set("tagName",tagName)}});jsgui[tagName].prototype._tag_name=tagName;map_Controls[tagName]=jsgui[tagName]});var core_extension_no_closing_tag=str_arr_mapify(function(tagName){jsgui[tagName]=Control.extend({init:function(spec){this._super(spec);this.get("dom").set("tagName",tagName);this.get("dom").set("noClosingTag",true)}});jsgui[tagName].prototype._tag_name=tagName;map_Controls[tagName]=jsgui[tagName]});core_extension("html head title body div span h1 h2 h3 h4 h5 label p a script button form img ul li audio video");core_extension_no_closing_tag("link input");jsgui.Label=Control.extend({fields:[["for","control"]],init:function(spec){this._super(spec);this.set("dom.tagName","label")},beforeRenderDomAttributes:function(){var _for=this.get("for");if(tof(_for)=="control"){var domAttributes=this.get("dom.attributes");domAttributes.set("for",_for._id())}}});var HTML_Document=jsgui.html.extend({render_dtd:function(){return'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n'}});var Blank_HTML_Document=HTML_Document.extend({init:function(spec){this._super(spec);var context=this._context;if(!spec.el){var head=new jsgui.head({context:context});this.get("content").add(head);var title=new jsgui.title({context:context});head.get("content").add(title);var body=new jsgui.body({context:context});this.get("content").add(body);this.set("head",head);this.set("title",title);this.set("body",body);this.connect_fields(["head","body","title"])}},body:fp(function(a,sig){if(sig=="[]"){var content=this.get("content");var body=content.get(1);return body}})});var Client_HTML_Document=Blank_HTML_Document.extend({init:function(spec){this._super(spec);this.active()},include_js:function(url){var head=this.get("head");var script=new jsgui.script({context:this._context});var dom=script.get("dom");var domAttributes=dom.get("attributes");domAttributes.set("type","text/javascript");domAttributes.set("src",url);head.content().add(script)},include_css:function(url){var head=this.get("head");var link=new jsgui.link({context:this._context});var dom=link.get("dom");var domAttributes=dom.get("attributes");domAttributes.set("rel","stylesheet");domAttributes.set("type","text/css");domAttributes.set("href",url);head.content().add(link)},include_jsgui_client:function(js_file_require_data_main){js_file_require_data_main=js_file_require_data_main||"/js/web/jsgui-html-client";var head=this.get("head");var script=new jsgui.script({context:this._context});var domAttributes=script.get("dom.attributes");domAttributes.set({type:"text/javascript",src:"/js/web/require.js","data-main":js_file_require_data_main});head.add(script)},include_jsgui_resource_client:function(path){var js_file_require_data_main=path||"/js/web/jsgui-html-resource-client";this.include_jsgui_client(js_file_require_data_main)},include_client_css:function(){var head=this.get("head");var link=new jsgui.link({context:this._context});var domAttributes=link.get("dom.attributes");domAttributes.set("rel","stylesheet");domAttributes.set("type","text/css");domAttributes.set("href","/css/basic.css");head.content().add(link)}});jsgui.activate=activate;jsgui.recursive_dom_iterate=recursive_dom_iterate;jsgui.recursive_dom_iterate_depth=recursive_dom_iterate_depth;jsgui.get_window_size=get_window_size;jsgui.Client_HTML_Document=Client_HTML_Document;jsgui.hover_class=hover_class;jsgui.group_hover_class=group_hover_class;var Page_Context=Class.extend({init:function(spec){spec=spec||{};if(spec.browser_info){this.browser_info=spec.browser_info}if(spec.resource_pool){this.resource_pool=spec.resource_pool}this.get_vector_methodology=function(){if(this.browser_info.ie){return"vml"}else{return"svg"}};var map_new_ids={};var map_objects={};var _get_new_typed_object_id=function(type_name){if(!is_defined(map_new_ids[type_name])){map_new_ids[type_name]=0}var res=type_name+"_"+map_new_ids[type_name];map_new_ids[type_name]++;return res};this.new_id=_get_new_typed_object_id;this.set_max_ids=function(map_max_ids){each(map_max_ids,function(i,v){map_new_ids[i]=v+1})};var map_Controls=this.map_Controls={};var map_controls=this.map_controls={};map_Controls["control"]=Control},make:function(abstract_object){if(abstract_object._abstract){var constructor=abstract_object.constructor;var aos=abstract_object._spec;aos.abstract=null;aos.context=this;var res=new constructor(abstract_object._spec);return res}else{throw"Object must be abstract, having ._abstract == true"}},update_Controls:fp(function(a,sig){if(sig=="[o]"){var o=a[0];var map_Controls=this.map_Controls;each(o,function(name,Constructor){name=name.toLowerCase();map_Controls[name]=Constructor})}if(sig=="[s,f]"){var name=a[0];var Constructor=a[1];name=name.toLowerCase();this.map_Controls[name]=Constructor}}),begin_drag_ctrl:function(e_begin,ctrl){},raise:function(event_name){var a=arguments;var a2=[];if(a.length>1){for(var c=1;c<a.length;c++){a2.push(a[c])}}if(this.__bound_events){var corresponding_events=this.__bound_events[event_name];for(var c=0,l=corresponding_events.length;c<l;c++){if(a2.length>0){corresponding_events[c].apply(this,a2)}else{corresponding_events[c].apply(this)}}}},listen:function(event_name,handler){this.__bound_events=this.__bound_events||{};this.__bound_events[event_name]=this.__bound_events[event_name]||[];this.__bound_events[event_name].push(handler)},move_drag_ctrl:function(e_move,ctrl){var window_size=get_window_size();var from_left,from_top,from_right,from_bottom;var clientX=e_move.clientX;var clientY=e_move.clientY;var margin=64;var is_left=clientX<=margin;var is_top=clientY<=margin;var is_right=clientX>=window_size[0]-margin;var is_bottom=clientY>=window_size[1]-margin;if(is_top){this.raise("drag-ctrl-top")}else if(is_bottom){this.raise("drag-ctrl-bottom")}else if(is_left){this.raise("drag-ctrl-left")}else if(is_right){this.raise("drag-ctrl-right")}else{this.raise("drag-ctrl-no-zone")}},end_drag_ctrl:function(e_end,ctrl){this.raise("drag-ctrl-end",e_end,ctrl)},drop_ctrl:function(ctrl,zone){if(this.full_window){this.anchor(ctrl,zone)}},anchor:function(ctrl,zone){console.log("page context anchor ");if(this.full_window){var fw=this.full_window;var g9=fw.get("grid_9");if(g9){g9.anchor_ctrl(ctrl,zone)}var fwtn=fw.__type_name}},begin_drag_selection_scope:function(e_begin,selection_scope){console.log("page context drag selection_scope "+selection_scope);var map_selected_controls=selection_scope.map_selected_controls;var arr_selected=jsgui.true_vals(map_selected_controls);console.log("arr_selected.length "+arr_selected.length);var shallow_copies_selected=jsgui.shallow_copy(arr_selected);this.drag_selected=arr_selected;var ctrl_abs=this.make(Control({}));ctrl_abs.add(shallow_copies_selected);var screenX=e_begin.screenX;var screenY=e_begin.screenY;var clientX=e_begin.clientX;var clientY=e_begin.clientY;ctrl_abs.set("dom.attributes.style","position: absolute; left: "+clientX+"px; top:"+clientY+"px; height: 200px; width: 320px; background-color: #EEEEEE");var html=ctrl_abs.all_html_render();var el_ctr=document.createElement("div");el_ctr.innerHTML=html;var el_abs=el_ctr.childNodes[0];document.body.appendChild(el_abs);ctrl_abs.set("el",el_abs);this.ctrl_abs=ctrl_abs},move_drag_selection_scope:function(e_move){console.log("page context move_drag_selection_scope");var clientX=e_move.clientX;var clientY=e_move.clientY;var style="position: absolute; left: "+clientX+"px; top:"+clientY+"px; height: 200px; width: 320px; background-color: #EEEEEE";var el=this.ctrl_abs.get("el");el.style.cssText=style},end_drag_selection_scope:function(e_end){if(this.ctrl_abs){this.ctrl_abs.remove();this.ctrl_abs=null}},ensure_dock_placeholder:function(pos){var fw=this.full_window;if(fw){fw.ensure_dock_placeholder(pos)}}});jsgui.Page_Context=Page_Context;var Client_Page_Context=jsgui.Page_Context.extend({init:function(spec){spec=spec||{};this._super(spec);this.document=spec.document||document}});jsgui.Client_Page_Context=Client_Page_Context;var Horizontal_Slider=Control.extend({fields:[["min",Number],["max",Number],["value",Number],["drag_mode",String]],init:function(spec,add,make){this._super(spec);this.__type_name="horizontal_slider";if(!spec.abstract&&!spec.el){var div_relative=add(Control({"class":"relative"}));this.set("dom.attributes.class","horizontal slider");var h_bar=make(Control({"class":"h-bar"}));var v_bar=make(Control({"class":"v-bar"}));div_relative.add(h_bar);div_relative.add(v_bar);var ctrl_fields={div_relative:div_relative._id(),h_bar:h_bar._id(),v_bar:v_bar._id()};this.set("dom.attributes.data-jsgui-ctrl-fields",stringify(ctrl_fields).replace(/"/g,"'"));var min=this.get("min").value();var max=this.get("max").value();var value=this.get("value").value();var obj_fields={min:min,max:max,value:value};var drag_mode=this.get("drag_mode");if(drag_mode){obj_fields.drag_mode=drag_mode.value()}this.set("dom.attributes.data-jsgui-fields",stringify(obj_fields).replace(/"/g,"[DBL_QT]").replace(/'/g,"[SNG_QT]"));this.active()}},activate:function(el){this._super(el);console.log("Horizontal Slider activate");var that=this;var div_relative=this.get("div_relative");var h_bar=this.get("h_bar");var v_bar=this.get("v_bar");var ghost_v_bar;var size=this.size();var size_v_bar=v_bar.size();var w_v_bar=size_v_bar[0];var h_w_v_bar=w_v_bar/2;var h_padding=5;var h_bar_width=size[0]-h_padding*2;h_bar.style({width:h_bar_width+"px"});var ctrl_html_root=this._context.ctrl_document;var pos_down,pos_current,pos_offset;var orig_v_bar_l=parseInt(v_bar.style("left"),10);var new_v_bar_l;var drag_mode;var prop;var ctrl_ghost_v_bar;var context=this._context;var v_bar_center_pos;var v_bar_center_pos_when_pressed;var ensure_ctrl_ghost_v_bar=function(){if(!ctrl_ghost_v_bar){ctrl_ghost_v_bar=new Control({context:this._context,"class":"ghost v-bar"});div_relative.add(ctrl_ghost_v_bar);ctrl_ghost_v_bar.activate()}else{div_relative.add(ctrl_ghost_v_bar)}};var fn_mousemove=function(e_mousemove){var bcr_h_bar=h_bar.bcr();var bcr_h_bar_x=bcr_h_bar[0][0];var bcr_h_bar_w=bcr_h_bar[2][0];var up_offset_from_bcr_h_bar_x=e_mousemove.pageX-bcr_h_bar_x;if(up_offset_from_bcr_h_bar_x<0)up_offset_from_bcr_h_bar_x=0;if(up_offset_from_bcr_h_bar_x>bcr_h_bar_w)up_offset_from_bcr_h_bar_x=bcr_h_bar_w;if(drag_mode=="ghost"){ensure_ctrl_ghost_v_bar();ctrl_ghost_v_bar.style("left",up_offset_from_bcr_h_bar_x+"px")}else{v_bar.style("left",up_offset_from_bcr_h_bar_x+"px")}};var fn_mouseup=function(e_mouseup){console.log("e_mouseup",e_mouseup);ctrl_html_root.off("mousemove",fn_mousemove);ctrl_html_root.off("mouseup",fn_mouseup);var bcr_h_bar=h_bar.bcr();console.log("bcr_h_bar",bcr_h_bar);var bcr_h_bar_x=bcr_h_bar[0][0];var bcr_h_bar_w=bcr_h_bar[2][0];var up_offset_from_bcr_h_bar_x=e_mouseup.pageX-bcr_h_bar_x;console.log("up_offset_from_bcr_h_bar_x",up_offset_from_bcr_h_bar_x);if(up_offset_from_bcr_h_bar_x<0)up_offset_from_bcr_h_bar_x=0;if(up_offset_from_bcr_h_bar_x>bcr_h_bar_w)up_offset_from_bcr_h_bar_x=bcr_h_bar_w;var prop=up_offset_from_bcr_h_bar_x/bcr_h_bar_w;console.log("prop",prop);if(drag_mode=="ghost"){ctrl_ghost_v_bar.remove();var min=that.get("min");if(min.value)min=min.value();var max=that.get("max");if(max.value)max=max.value();console.log("pos_down",pos_down);var new_val=prop*max;console.log("new_val",new_val);that.set("value",new_val)}else{orig_v_bar_l=new_v_bar_l}};v_bar.on("mousedown",function(e_mousedown){var dm=that.get("drag_mode");if(dm){drag_mode=dm.value()}v_bar_center_pos_when_pressed=v_bar_center_pos;console.log("drag_mode",drag_mode);ctrl_html_root.on("mousemove",fn_mousemove);ctrl_html_root.on("mouseup",fn_mouseup);ctrl_html_root.add_class("dragging");pos_down=[e_mousedown.pageX,e_mousedown.pageY]});this.on("change",function(e_change){var name=e_change.name,value=e_change.value;if(name=="value"){var min=that.get("min");if(min.value)min=min.value();var max=that.get("max");if(max.value)max=max.value();prop=value/max;var size_h_bar=h_bar.size();v_bar_center_pos=Math.round(size_h_bar[0]*prop+h_padding-h_w_v_bar);v_bar.style("left",v_bar_center_pos+"px")}})}});jsgui.Horizontal_Slider=Horizontal_Slider;console.log("jsgui loaded");